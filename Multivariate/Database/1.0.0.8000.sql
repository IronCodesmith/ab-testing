--beginvalidatingquery
	if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_DatabaseVersion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
    begin
		 select 1, 'Upgrading database'
    end
    else
		select -1, 'Not an EPiServer database'
--endvalidatingquery

-- Create MultivariateTest Tables to Store MultivariateTest Information.
DECLARE @CurrentMigration [nvarchar](max)

IF object_id('[dbo].[__MigrationHistory]') IS NOT NULL
    SELECT @CurrentMigration =
        (SELECT TOP (1) 
        [Project1].[MigrationId] AS [MigrationId]
        FROM ( SELECT 
        [Extent1].[MigrationId] AS [MigrationId]
        FROM [dbo].[__MigrationHistory] AS [Extent1]
        WHERE [Extent1].[ContextKey] = N'EPiServer.Marketing.Multivariate.Dal.Migrations.Configuration'
        )  AS [Project1]
        ORDER BY [Project1].[MigrationId] DESC)

IF @CurrentMigration IS NULL
    SET @CurrentMigration = '0'

IF @CurrentMigration < '201512222034080_Initial'
BEGIN
    CREATE TABLE [dbo].[tblConversion] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [ConversionString] [nvarchar](max) NOT NULL,
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblConversion] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblConversion]([TestId])
    CREATE TABLE [dbo].[tblMultivariateTest] (
        [Id] [uniqueidentifier] NOT NULL,
        [Title] [nvarchar](255) NOT NULL,
        [Owner] [nvarchar](100) NOT NULL,
        [OriginalItemId] [uniqueidentifier] NOT NULL,
        [TestState] [int],
        [StartDate] [datetime] NOT NULL,
        [EndDate] [datetime] NOT NULL,
        [LastModifiedBy] [nvarchar](100),
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblMultivariateTest] PRIMARY KEY ([Id])
    )
    CREATE TABLE [dbo].[tblKeyPerformanceIndicator] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [KeyPerformanceIndicatorId] [uniqueidentifier],
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblKeyPerformanceIndicator] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblKeyPerformanceIndicator]([TestId])
    CREATE TABLE [dbo].[tblMultivariateTestResult] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [ItemId] [uniqueidentifier] NOT NULL,
        [Views] [int] NOT NULL,
        [Conversions] [int] NOT NULL,
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblMultivariateTestResult] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblMultivariateTestResult]([TestId])
    CREATE TABLE [dbo].[tblVariant] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [VariantId] [uniqueidentifier] NOT NULL,
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblVariant] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblVariant]([TestId])
    ALTER TABLE [dbo].[tblConversion] ADD CONSTRAINT [FK_dbo.tblConversion_dbo.tblMultivariateTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblMultivariateTest] ([Id]) ON DELETE CASCADE
    ALTER TABLE [dbo].[tblKeyPerformanceIndicator] ADD CONSTRAINT [FK_dbo.tblKeyPerformanceIndicator_dbo.tblMultivariateTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblMultivariateTest] ([Id]) ON DELETE CASCADE
    ALTER TABLE [dbo].[tblMultivariateTestResult] ADD CONSTRAINT [FK_dbo.tblMultivariateTestResult_dbo.tblMultivariateTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblMultivariateTest] ([Id]) ON DELETE CASCADE
    ALTER TABLE [dbo].[tblVariant] ADD CONSTRAINT [FK_dbo.tblVariant_dbo.tblMultivariateTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblMultivariateTest] ([Id]) ON DELETE CASCADE
    CREATE TABLE [dbo].[__MigrationHistory] (
        [MigrationId] [nvarchar](150) NOT NULL,
        [ContextKey] [nvarchar](300) NOT NULL,
        [Model] [varbinary](max) NOT NULL,
        [ProductVersion] [nvarchar](32) NOT NULL,
        CONSTRAINT [PK_dbo.__MigrationHistory] PRIMARY KEY ([MigrationId], [ContextKey])
    )
    INSERT [dbo].[__MigrationHistory]([MigrationId], [ContextKey], [Model], [ProductVersion])
    VALUES (N'201512222034080_Initial', N'EPiServer.Marketing.Multivariate.Dal.Migrations.Configuration',  0x1F8B0800000000000400ED5CDD6EDB3614BE1FB0771074B50DA9E5A428B005768B343F45B0A629E2B4D85DC148B44354A25C914A1D0C7BB25DEC91F60A3BB2FE4951A26439953BA3409150E4479EC38F8787E439F9F7EF7F26AF569E6B3CE080119F4ECDC3D1D83430B57D87D0C5D40CF9FCD9AFE6AB973FFE303977BC95F131ADF73CAA072D299B9AF79C2F8F2D8BD9F7D8436CE4113BF0993FE723DBF72CE4F8D6D178FC9B75786861803001CB30263721E5C4C3EB5FE0D7539FDA78C943E45EF90E7659520E5F666B54E31DF2305B221B4FCDF3F764860318F1E80A059F3187818EAE429793071410C4F1E80CB9A671E21204639B61776E1A88529F230E233FFEC0F08C073E5DCC965080DCDBC725867A73E4329C48749C57D7156E7C140967E50D53283B64DCF75A021E3E4FB46589CD3BE9DCCCB409FA3C07BDF3C748EAB54EA726A83E997DD310BB3B3E7583A8AA86D2D7F336CAC10E0CBD260719A7C6A3F5BF03E3142A85019E521CF200418DF7E19D4BECDFF1E3ADFF19D3290D5DB728134805DF4A0550F43EF09738E08F37789E487AE99886556E67890DB3668536B106DE84047E7E077DA33B17678CB16A9BDF62C63784C8550ABC051DA660E96F5768F516D305BF9F9AF0A3695C901576D292A4870F94C08A86463C0871FB110418A6CB3983FFD2CEA39F6F61FDB6C682392773D215EC1D7A208B353345D802AF229D9BC60D76D715D93D59C666A040CE4F72FD8BC0F76E7CB7A470A9DAA7991F06763470BFB9EE2D0A169897659858F9FAAB5D95F200375E9B22E47E85AE5728E12EAE5953472F5E6C634D5D7FA538A8E9F6703CDE4AB70159108ADC4B8EBD1E4CDB8C1796F125E5CF8F9A5A418B80F76249CE693F16E92D623CB54AAF1F7B98929D37A6B95163DBB2A3A96DD4B1A3A9CDD51D3E188CF73898FB01184B1B5F5287D888FB41B52C8ACAB582E9B691A4D46ED8566411E0063328A996B8BA6EADC09A4D247975DBB515F763D4962AE44B3ED60AA4AA2349A0AC583564EDCD5DC1831EF67805F27EABEFC91957E85744DDF92D40CB9FDEAAED143DEDD646B717B73BB6585B70BE63E0FDBAEC695DF6E0CF7E24F82B137CD9CE47F54D81BE130BB1455F43B40F6D7D944EE62171077AB00709D2DE00F46400127D6E7AD7F69DACBB8D7C607165353ACB3A4BE98431DF26EB71D6BB52F298CB8A8163BFD1D595884FF635AE0B9CF7A3C64B584720C3D4FC459A970EDD67678ABC7B795ECAFD1E9AE23ABDA667D8C51C1B2776FC8C708A988D1C9938A07FA75C024B1B0798468F1DB0413130168472D90E106A9325723B4A27E0695A9668BC59CFE29733BCC4D48181779C6F9D21A596471E56D6BBA0DE266D4EAC02D5EB5780EEEEA86260EBAD524DC0D4CFD5A77FEB3B815D627F4BE19E80FC2DE77AF0DC57EE502ABE356F5739C132374D9FCECD3742BBC4DF26699E80B04DF3357886D6DD72AB58A4F5749813A9F8F4AE4F55AD7BF55D62AB86404F40588DB91B1867634F1BDA70688183640070C6407788E1A81CAFAACEAA1FE0637C5C65C99B9548B508778679458448EEDD577058A26C1947542BAB8093D9DA00AA7EED91B0954E7FDB7167CF2B8DC34FFDAA861EF2070D0931DBCB048802271A9551710E2C346F7B9B2B127B831359A687BA799456D20667B04287156C14CD5B59C71AFAD7BEEF92D5DFE930B0D171A04E1719C36B94DFF604B065DDABEF3C6465EB799FEDFCCF8278F972AE515FA3C7B9657DD5BEE2CB2AD376875A3B440539D59B496B0FA827EDA5F759D92E9B7D9B5871686A5230B11431AC932BB45C12BA28C4B42625C62C0E683D7D366B1FD7E9C51896CD2AC23BB3D1663D8155440B2C7C8D34E9E00B12309E7A0DA671EA785235D1A750EC66696F92DB204F65BACBA54DA29F93B81E8DF0DE911A3B57EF0548EC45FE5D243CAE6699D4D888228E918B828A1BEE53DF0D3DAA7636D5AD53A7B088A07214D528722468114FFEDA02B978EF5D022D7ED0C72BDF7D1701CB5F64C48925CC9EE4464BDC91CE2465366A71553611BD53B6C96A6A10B719624BF48D63244BEC8D8BF4319280C7224652D40243885E2C8109DFDA2DCE2490515C9F49B13E5621BCB1885528D6C7CA021C8B4859A13E8E18E0588413BFED4D86B6C9501E587AB71CAA736B7B03A28D34E46DB02606AB085C536DCFF2EE1B637A32DCFAFE985C9D6CBE4BAA8086CCF1AA1DAEFDCE968434154192A22E4E2753F99BEDF0FEEF2B2ABB1CE87D05A55785ED978CB2E590D74821E4A7C4F0BC78CF4AE1B3749B2156C97ACF6E3584DB8B497293D09CA62B5D2DC4554C0354F5409CE85A61F6C8C0A68DA20AA3D917F7D42538BAE94E2B5C214AE6408B389ECD3C1A1F1E0979BDC3C9B1B51873DC8A9B98EA44DBF28C3D41585E48C9971093E8F529625FB061889E0C273D3281C3855753F3CF75FB63E3F28F4F31C481711DC0DC1E1B63E3AFDE7261299841FB1E053F7968F5731F517F0EFCCCFB8AFAD304EB9E1BBA83742A665DA6B327E75D6E92545989BACEE1EB2567B2971555CA9F2491EDCB41749209A56CCACEBC15B2293BE3546753EACC45C7E4C941AF54ADF3F66E2CD841D8FFC6F4AB3A39BF4782E99C75F7FCEA9846B4B150A59422C1BC774D28EA04B363ACAE3C8EEE69DC3D196663B906CEA02D6497C83111DF2AA6B231DCA99FCC965E02E5BF611EC8D0A233B79FEF31044AAA021E7BC835D919426ABF5C0C8C8FAD73308648C02C3EB64BFEC7CE504C7DB53F304E75C99A1822AD8A91881D333676865CB5C17403CC70908316C559EC98BF10BF5080377AE7C3AC27B70677EE06290E5A190E8A6EFB4A85689309A1184A5F9913E9D6AF9D37A1A99A7669167559168A0E77290B43C5C1EA10C20EE9153A791BDF5B32457725D6AF81BA8895C1E744F4A72461659682127624D5A13F65C8FB554372443FF90BF2CB3EECDC853FD30D7E03238B1C22FAA3DD14DBA53D3BAB7349E77EEA3A08234AAB88D74298230736F493809339B2397CB63163EB57DE8FC80DA1CAB977879D4B7A1DF265C84164ECDDB9A5A0D5C805A9EB7F9DA4511EF3E47AB9FEE3297D8800C324D14DD6357D1D12D7C9C67D517193A580887C9B3718CAE3B9045789E3C56386F4CEA79A4089FA3297EC167B4B17C0D8359DA107DC656C1F187E8B17C87E4C0334D420CD135156FBE48CA045803C9660E4EDE157E0B0E3AD5EFE076A67A297AD5E0000 , N'6.1.3-40302')
END


GO
