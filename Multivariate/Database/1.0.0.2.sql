--beginvalidatingquery
	if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_DatabaseVersion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
    begin
		 select 1, 'Upgrading database'
    end
    else
		select -1, 'Not an EPiServer database'
--endvalidatingquery

-- Create MultivariateTest Tables to Store MultivariateTest Information.
DECLARE @CurrentMigration [nvarchar](max)

IF object_id('[dbo].[__MigrationHistory]') IS NOT NULL
    SELECT @CurrentMigration =
        (SELECT TOP (1) 
        [Project1].[MigrationId] AS [MigrationId]
        FROM ( SELECT 
        [Extent1].[MigrationId] AS [MigrationId]
        FROM [dbo].[__MigrationHistory] AS [Extent1]
        WHERE [Extent1].[ContextKey] = N'EPiServer.Marketing.Testing.KPI.Migrations.Configuration'
        )  AS [Project1]
        ORDER BY [Project1].[MigrationId] DESC)

IF @CurrentMigration IS NULL
    SET @CurrentMigration = '0'

IF @CurrentMigration < '201602161526113_Initial'
BEGIN
    CREATE TABLE [dbo].[tblKeyPerformaceIndicator] (
        [Id] [uniqueidentifier] NOT NULL,
        [Name] [nvarchar](max) NOT NULL,
        [Weight] [int] NOT NULL,
        [Value] [nvarchar](max) NOT NULL,
        [ParticipationPercentage] [int] NOT NULL,
        [ConversionPage] [uniqueidentifier] NOT NULL,
        CONSTRAINT [PK_dbo.tblKeyPerformaceIndicator] PRIMARY KEY ([Id])
    )
    IF object_id('[dbo].[__MigrationHistory]') IS NULL
	BEGIN
		CREATE TABLE [dbo].[__MigrationHistory] (
			[MigrationId] [nvarchar](150) NOT NULL,
			[ContextKey] [nvarchar](300) NOT NULL,
			[Model] [varbinary](max) NOT NULL,
			[ProductVersion] [nvarchar](32) NOT NULL,
			CONSTRAINT [PK_dbo.__MigrationHistory] PRIMARY KEY ([MigrationId], [ContextKey])
		)
	END
    INSERT [dbo].[__MigrationHistory]([MigrationId], [ContextKey], [Model], [ProductVersion])
    VALUES (N'201602161526113_Initial', N'EPiServer.Marketing.Testing.KPI.Migrations.Configuration',  0x1F8B0800000000000400CD58DD6EDB3614BE1FB0771078B501A9989F9B2E905B64765218A913A34ADB6B5A3AB28992944A5281FD6CBDD823ED1576A87FCB766CC7C536047024F29C8FE7F7E3B1FFFEF157F07E2985F70CDAF0540DC8857F4E3C50511A73351F90DC266FDE92F7EF7EFD25B88DE5D2FB52CB5D3939D454664016D666D7949A680192195FF248A7264DAC1FA592B238A597E7E77FD08B0B0A084110CBF3824FB9B25C42F182AFC3544590D99C89491A8330D53AEE8405AAF7C024988C453020B7531E82468BFD09D3DFC0A2A1FE1398E2FFFD74EC8F9820DE8DE00C4D0B4124C4634AA5965934FCFAB381D0EA54CDC30C1798785A6580720913062A87AE5BF1437D3BBF74BED156B1868A7263537924E0C555152CDA577F55C849134C0CE72D86DDAE9CD7454807E43EE3C4EB9F733D14DAC9EC0F76912E1F41CEBC3DA2674DF1608DB9BF336F980B9B6B1828C8AD66E2CC9BE633C1A37B583DA5DF400D542E44D77AB41FF7D6167069AAD30CB45D7D82A4F2691C138FAEEBD1BE62A3D6D1295DFE90737C7EC0B3D94C40531BF44575F759036081A1CFC49BB0E5475073BB18107C24DE1D5F425CAF54A89F15C75E4325AB7338FAD4AFC0E70B5B9F3B56F6EAF2688C2F4CE4FF81E953A62D8F7856D4DB147404CAB2399CE60BD248C564D30ED601090D68DB189BED82B0967105BA3A66C42C9B31036E1D96764BFF20CD542D64AAF8ACDB5DE28660DB2E34C46B6D2899CB2F9A739B9D8D452D51D292296B46A53B283598B02CC31C7728B65AF1C2925F876FC2E37946961834325BE8A6B1B639C9A61A13D4DB75F98BE18E6B63EB08136F18CB0DB17EFC77C4B63EAD13E23E77B411AF85DD73A970C03D5324A887D906F40E7D9458D685BBD0985572EE865671D731C1F416621AA622976A17B9BDA45DF25257BF5C391CA1E6982E46BD76384AC5325D906AE9708C9D94D145DD2974F8397D16E9C2F7F7365103DA4B7FBFE6E846D1F5AEAA7E01BFD4FF7D91E6F486077AFD1E54BDB77FCEDA68C652847818AE671EBB460C57C682F49D801F7E1743C1D1DF5660C2144FB063CADB9C2057BCED4D66FF9F29891A138BFDA3D2BF3E8DE48A7FCF01A389D6241CF44993897A663A5A30FD9B64CBDF4F9C36B8CBF429B3C669C6EC991F5E63DDF6E9E1C8041C37496C5E787BE7845D6342D99D0312CF5234BDB4CFCE04561A462749B5C4A61EAB98470C09E0D553C5267B04B4FB5D2E1881E1F316C27DB35310B924B5A0B5CC5825699D03F4B16B512DD24BD1042C8B31543798FC844516B72330A698598BE2C26B5BCE201EABC7DC66B9BD3106E44CACBAFE06F4E5F38BD169DDE6E031736FE667B880667274011ED59F39177163F7DD965ADA01E1AAE603E07A51FC38B323DC7CD5203DA4EA40A02A7C23C840B9027F02990904338F2A64CFF01ADB70F2FD087316ADEA4B6037C8FE44AC873D187136D74C9A0AA3D577BF4F50F703C5BB7F00648D5C37D2100000 , N'6.1.3-40302')
END




GO
