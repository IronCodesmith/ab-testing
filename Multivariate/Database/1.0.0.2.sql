--beginvalidatingquery
	if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_DatabaseVersion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
    begin
		 select 1, 'Upgrading database'
    end
    else
		select -1, 'Not an EPiServer database'
--endvalidatingquery

-- Create MultivariateTest Tables to Store MultivariateTest Information.
DECLARE @CurrentMigration [nvarchar](max)

IF object_id('[dbo].[__MigrationHistory]') IS NOT NULL
    SELECT @CurrentMigration =
        (SELECT TOP (1) 
        [Project1].[MigrationId] AS [MigrationId]
        FROM ( SELECT 
        [Extent1].[MigrationId] AS [MigrationId]
        FROM [dbo].[__MigrationHistory] AS [Extent1]
        WHERE [Extent1].[ContextKey] = N'EPiServer.Marketing.Testing.KPI.Migrations.Configuration'
        )  AS [Project1]
        ORDER BY [Project1].[MigrationId] DESC)

IF @CurrentMigration IS NULL
    SET @CurrentMigration = '0'

IF @CurrentMigration < '201602171933372_Initial'
BEGIN
    CREATE TABLE [dbo].[tblKeyPerformaceIndicator] (
        [Id] [uniqueidentifier] NOT NULL,
        [Name] [nvarchar](max) NOT NULL,
        [Weight] [int],
        [Value] [nvarchar](max) NOT NULL,
        [ParticipationPercentage] [int],
        [LandingPage] [uniqueidentifier] NOT NULL,
        [RunAt] [int] NOT NULL,
        CONSTRAINT [PK_dbo.tblKeyPerformaceIndicator] PRIMARY KEY ([Id])
    )
    IF object_id('[dbo].[__MigrationHistory]') IS NULL
	BEGIN
		CREATE TABLE [dbo].[__MigrationHistory] (
			[MigrationId] [nvarchar](150) NOT NULL,
			[ContextKey] [nvarchar](300) NOT NULL,
			[Model] [varbinary](max) NOT NULL,
			[ProductVersion] [nvarchar](32) NOT NULL,
			CONSTRAINT [PK_dbo.__MigrationHistory] PRIMARY KEY ([MigrationId], [ContextKey])
		)
	END
    INSERT [dbo].[__MigrationHistory]([MigrationId], [ContextKey], [Model], [ProductVersion])
    VALUES (N'201602171933372_Initial', N'EPiServer.Marketing.Testing.KPI.Migrations.Configuration',  0x1F8B0800000000000400CD58DB6EE336107D2FD07F10F8D40259D3495EB681BC8BD4491646E2C45865B7CFB434B689A5282D4905F6B7F5A19FD45FE850A2AEBEDBBD2140628F660E670EE7A6FCF9FB1FFEC7652CBC37509A2772402E7B7DE2810C9388CBF9806466F6EE3DF9F8E1C71FFCFB285E7A5F4BBD6BAB8796520FC8C298F486521D2E2066BA17F350253A99995E98C4944509BDEAF77FA197971410822096E7F99F3369780CF917FC3A4C6408A9C99818271108EDE4F824C851BD6716834E590803723FE10128F4B83766EA1B1874B4F70A3AFFFB3819F5EE9820DEADE00C5D0B40CC88C7A44C0C33E8F8CD170D8151899C07290A98785DA5807A332634B8806E6AF54363EB5FD9D8686D5842859936497C24E0E5B5238B76CD4FA29C5464229DF748BB59D9A8734A07E431E5C4EB9E733314CAEAEC273BBFAE1E825C787B542FAAE4C11CB33F17DE3013265330909019C5C48537C9A682878FB07A4DBE811CC84C88A6F7E83F3E6B09503451490ACAAC3EC3CCC5348A8847DB76B46B5899356C8A903F651C3F3FE3D96C2AA0CA0DBAD3DCFE2E0130C13066E28DD9F209E4DC2C06043F12EF812F212A250EF58BE4586B68645406479FFA1BF0F9C294E78EA4B9BEDA67F29589EC3FF074C294E1214FF3F49A800A411A3687A35C7F62D276A549C3EEA4BBC2DE735B91663B44CF4976E2F8B4AE9D76456571A39E1CD4483F0836AF3BCBB915664FD1859FFF58A5E11547A0C40A619AB7D2E6720CF114940BB6F0827879520D487F8DF996F65070BCF54AFB729DDF82C9F57E85E3C1302E2BA43B66D89469B072589A0DF4629F770C6B97B16DC70ADC004CDD0635F1EA1B76899177C74D595079544F2A5A8CAA72A4D12D33CD1FB334458A1B33CE49BCA01870C377C1F18D3E2E3068A837F4FBCADBEA2493282CA3CE533C1A3D7DE04A9B9261E20DA3784DADCBFF166ECBD31A14779B77CD78A96C3F1706070CFAFC823A9835A10F18638C2997870B955BC5D05BB3CA970D2698DA30198689C862B96DBAECB22E0643D3BE901C8E5036F92646293B1CC5F5FD2688131D8EB1B5893751B72A1D7E4EABD137B15B0F0EC7733DB989E444EB183EED244F3763E95ACA76368D6EFAEFEA1E5D95EAF4AA8B74BA85EF2A77FF9ABC56CA850AF1909C371ED9320E56DA40DCB30ABDE0BB28FB73A9306692CFB0DE8A1141B0D3BCEF2CD6FF9F25976A1D89FD9BEEBFBE4C66927FCF00D9446F66DCCECA33164BF9C654B860EAA7982D7F3E7359E4B2B5F0144BDD11ABE379BEEC59074F706EC3727836F7AD45B1E3D3511BE2A61D667DD4EEDD50B62D2845650F48344DD05BC7D954609622B5B344C5D81046484FC8B0799CBCCFAC771E9F365FE3FD3BD07C5E43D8977A09A1BDE11AB4D419C95952B28D31363D2A553A973106C322A4EA163367C642838F43D03A7F7F711BE53D2E9BD148BE6426CDCCADD6B87C8A55335E9FEE3E3F5FDADA3EFB2FA9FDA6FF8E10D04D8E21C08BFC35E322AAFC7ED8904B5B206CD67C0294E79583EF6F08375F5548CF893C10C8D1770729485B21AF10A702C1F48B0CD81B9CE21BEEDC4F3067E1AA1C20DB41F65F449B76FF8EB3B962B17618B5BDFDD714B5FF9BFAF0177E08A449CD120000 , N'6.1.3-40302')
END


GO
