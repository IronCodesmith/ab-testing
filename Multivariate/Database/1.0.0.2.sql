--beginvalidatingquery
	if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_DatabaseVersion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
    begin
		 select 1, 'Upgrading database'
    end
    else
		select -1, 'Not an EPiServer database'
--endvalidatingquery

-- Create MultivariateTest Tables to Store MultivariateTest Information.
DECLARE @CurrentMigration [nvarchar](max)

IF object_id('[dbo].[__MigrationHistory]') IS NOT NULL
    SELECT @CurrentMigration =
        (SELECT TOP (1) 
        [Project1].[MigrationId] AS [MigrationId]
        FROM ( SELECT 
        [Extent1].[MigrationId] AS [MigrationId]
        FROM [dbo].[__MigrationHistory] AS [Extent1]
        WHERE [Extent1].[ContextKey] = N'EPiServer.Marketing.KPI.Migrations.Configuration'
        )  AS [Project1]
        ORDER BY [Project1].[MigrationId] DESC)

IF @CurrentMigration IS NULL
    SET @CurrentMigration = '0'

IF @CurrentMigration < '201602221931580_Initial'
BEGIN
    CREATE TABLE [dbo].[tblKeyPerformaceIndicator] (
        [Id] [uniqueidentifier] NOT NULL,
        [Name] [nvarchar](max) NOT NULL,
        [Weight] [int],
        [Value] [nvarchar](max) NOT NULL,
        [LandingPage] [uniqueidentifier] NOT NULL,
        [RunAt] [int] NOT NULL,
        [ClientScripts] [nvarchar](max),
        CONSTRAINT [PK_dbo.tblKeyPerformaceIndicator] PRIMARY KEY ([Id])
    )
    IF object_id('[dbo].[__MigrationHistory]') IS NULL
	BEGIN
		CREATE TABLE [dbo].[__MigrationHistory] (
			[MigrationId] [nvarchar](150) NOT NULL,
			[ContextKey] [nvarchar](300) NOT NULL,
			[Model] [varbinary](max) NOT NULL,
			[ProductVersion] [nvarchar](32) NOT NULL,
			CONSTRAINT [PK_dbo.__MigrationHistory] PRIMARY KEY ([MigrationId], [ContextKey])
		)
	END
    INSERT [dbo].[__MigrationHistory]([MigrationId], [ContextKey], [Model], [ProductVersion])
    VALUES (N'201602221931580_Initial', N'EPiServer.Marketing.KPI.Migrations.Configuration',  0x1F8B0800000000000400CD58DB6EDB38107D5F60FF41E0D32E909AB9BC7403B945D64E0A2371625469F79996C636518A52492AB0BF6D1FF693F617762851773B76E2A05D0408ACD1CCE1CCE1DCEC7FFFFEC7FFB88E85F7044AF3440EC9D9E0947820C324E27239249959BC7B4F3E7EF8F517FF3A8AD7DED752EFC2EAA1A5D443B23226BDA454872B88991EC43C54894E1666102631655142CF4F4FFFA067671410822096E7F99F3369780CF9033E8E1219426A3226A64904423B39BE097254EF9EC5A05316C2905CCF78000A3D1E4C99FA06061D1DDCCE26833113C4BB129CA14B018805F198948961061DBEFCA221302A91CB204501138F9B14506FC1840617C865AD7E684CA7E736265A1B965061A64D12BF10F0ECC29144BBE6AFA29A5424228DD748B7D9D8A8732A87E436E5C4EB9E733912CAEAEC2639BF9E011A9F783B544EAA24C15CB27F27DE2813265330949019C5C48937CBE68287B7B0794CBE811CCA4C88A6B7E82FBE6B09503453490ACA6C3EC3C2C530898847DB76B46B5899356C8A103F651C3FDFE3D96C2EA0CA05FAACB9FD5F02604261CCC49BB2F51DC8A5590D097E24DE0D5F43544A1CEA17C9B1A6D0C8A80C5E7CEA5FC0972B539E3B91E6E27C9FC95726B29FE0E91D93B673CCD8128EE219FBC35515B0ADE68193BC106724384813848AA746BF011DCDD37C5A5755BBD6B2B85169CEF189BE116C59F79CD7D69E45D7051B6F5E83186D044A6C10A6996A6D86A710CF41B9E08AD38997A7DB909CF6EEA3A55DDC46A57DD6E7B360AEDFB9704018C66585346686CD99062B87B5D94227767CC7A87697D776ACC00DC0D40D1113A4BE519776799FDC76EB9547F5ACA2C5B02A871ADD31D5FC294B53A4B831E59CC40B8A11377A17BCBCE5C705060DF596CE5F795B9D64128545DA798B47A3A7375C6953324CBC5114F7D4BAFCEFE0B63CAD4171B7ADD78C97CAF67361F0CCA8CF2FA68355137983B1C5986A799850B9538CBD9E55BE6630C1D49659314A4416CB5DF3E639EB625434ED0BC9E10865DB6F6294B2C351DC24688238D1E118ADB6DE446ABD381CCFF5C42692131D8ED169ED4DACCEAB3EA64F3B89D2CD4ADA4BCBCE9ED14DF1E73A4457A53ABDEA149D8EE0BBEADCBF0CF7CAB550211E92F5C4235BAAC1461B88075661107C17650F2E15A64CF20568538C0182DDE47D678DFEFFACB454EB48ECDF6B7FF82A9949FE3D036413BD59703B0F8F582BE51353E18AA9DF62B6FEFDC85591CBD6CAD4DF61F62C8EC7F9B265193C9AA9D662D809EFF51BE1CE385FB2F56DDB53FAE374EF16B26B09292A7B48A279826E3BF7E602B374066A91A8181BC204090F19368F57EF2CFDCEE3D3E697757F0C9A2F6B08FBD55D42684BBA062D7526729194F4638C4D8F4A95CEED4CC1B008A9BA52981F2C34F83A04ADF375DD6D8DD7B8504613F990993433575AE3822936CD787DFAFCF9F962D6F6D97F48ED937E8B10D04D8E21C083FC33E322AAFCBEE967E72E089B359F00E579ABC4AF2B08B7DC5448F7893C10C8D1378614A4ADB94788538160FA4106EC095EE31BEED577B064E1A61C20BB41F65F449B767FCCD952B1583B8CDADEFE0045ED2F501FFE03BB9B390DB3120000 , N'6.1.3-40302')
END


GO
