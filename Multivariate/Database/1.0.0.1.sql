--beginvalidatingquery
	if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_DatabaseVersion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
    begin
		 select 1, 'Upgrading database'
    end
    else
		select -1, 'Not an EPiServer database'
--endvalidatingquery

-- Create MultivariateTest Tables to Store MultivariateTest Information.
DECLARE @CurrentMigration [nvarchar](max)

IF object_id('[dbo].[__MigrationHistory]') IS NOT NULL
    SELECT @CurrentMigration =
        (SELECT TOP (1) 
        [Project1].[MigrationId] AS [MigrationId]
        FROM ( SELECT 
        [Extent1].[MigrationId] AS [MigrationId]
        FROM [dbo].[__MigrationHistory] AS [Extent1]
        WHERE [Extent1].[ContextKey] = N'EPiServer.Marketing.Testing.Dal.Migrations.Configuration'
        )  AS [Project1]
        ORDER BY [Project1].[MigrationId] DESC)

IF @CurrentMigration IS NULL
    SET @CurrentMigration = '0'

IF @CurrentMigration < '201602191826094_Initial'
BEGIN
    CREATE TABLE [dbo].[tblABTest] (
        [Id] [uniqueidentifier] NOT NULL,
        [Title] [nvarchar](255) NOT NULL,
        [Owner] [nvarchar](100) NOT NULL,
        [OriginalItemId] [uniqueidentifier] NOT NULL,
        [State] [int],
        [StartDate] [datetime] NOT NULL,
        [EndDate] [datetime] NOT NULL,
        [LastModifiedBy] [nvarchar](100),
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABTest] PRIMARY KEY ([Id])
    )
    CREATE TABLE [dbo].[tblABKeyPerformanceIndicator] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier],
        [KeyPerformanceIndicatorId] [uniqueidentifier],
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABKeyPerformanceIndicator] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblABKeyPerformanceIndicator]([TestId])
    CREATE TABLE [dbo].[tblABTestResult] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [ItemId] [uniqueidentifier] NOT NULL,
        [ItemVersion] [int] NOT NULL,
        [Views] [int] NOT NULL,
        [Conversions] [int] NOT NULL,
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABTestResult] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblABTestResult]([TestId])
    CREATE TABLE [dbo].[tblABVariant] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [ItemId] [uniqueidentifier] NOT NULL,
        [ItemVersion] [int] NOT NULL,
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABVariant] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblABVariant]([TestId])
    ALTER TABLE [dbo].[tblABKeyPerformanceIndicator] ADD CONSTRAINT [FK_dbo.tblABKeyPerformanceIndicator_dbo.tblABTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblABTest] ([Id]) ON DELETE CASCADE
    ALTER TABLE [dbo].[tblABTestResult] ADD CONSTRAINT [FK_dbo.tblABTestResult_dbo.tblABTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblABTest] ([Id]) ON DELETE CASCADE
    ALTER TABLE [dbo].[tblABVariant] ADD CONSTRAINT [FK_dbo.tblABVariant_dbo.tblABTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblABTest] ([Id]) ON DELETE CASCADE
    CREATE TABLE [dbo].[__MigrationHistory] (
        [MigrationId] [nvarchar](150) NOT NULL,
        [ContextKey] [nvarchar](300) NOT NULL,
        [Model] [varbinary](max) NOT NULL,
        [ProductVersion] [nvarchar](32) NOT NULL,
        CONSTRAINT [PK_dbo.__MigrationHistory] PRIMARY KEY ([MigrationId], [ContextKey])
    )
    INSERT [dbo].[__MigrationHistory]([MigrationId], [ContextKey], [Model], [ProductVersion])
    VALUES (N'201602191826094_Initial', N'EPiServer.Marketing.Testing.Dal.Migrations.Configuration',  0x1F8B0800000000000400ED5C5B6FDB36147E1FB0FF20E871C82C2741812EB05BA44E52046B2E8893606F05231D3B4425CA25A934C6B05FB687FDA4FD851DD9BA92A22CC94EEA74411F6AF3F2F1903C171EF273FEFDFB9FC1FBC7C0B71E800B1AB2A1BDDBEBDB163037F4289B0EED484E7E7D6BBF7FF7F34F83632F78B46ED376FB713BECC9C4D0BE977276E038C2BD8780885E405D1E8A70227B6E1838C40B9DBD7EFF376777D70184B011CBB2065711933480C517FC3A0A990B331911FF2CF4C0174939D68C17A8D6390940CC880B43FBF8928E81A3C4BD33C2BF8044417BD72016FF1F11DFB60E7D4A50AC31F813DB228C85924814FAE046C058F2904DC7332C20FEF57C06D86E427C01C9640EF2E64DE7D5DF8BE7E5E41D53283712320C5A02EEEE270BE5A8DD3B2DB79D2D242EE5312EB99CC7B35E2CE7D03EFC10AF9B6DA9431D8C7C1E37AB5FEBC54EF596183BD6CA963B99F2F47B8B7F3BD628F265C461C820929C608BCBE8CEA7EEEF30BF0EBF001BB2C8F78B33C039605DA9008B2E7938032EE7573049E675EAD99653EEE7A81DB36E853ECB397F8C287E3EC7B1C99D0F997E38B5DDAFA9F42145402DC369DBD61979FC046C2AEF87F6DE9B37B675421FC14B4B12D81B46D1D8B093E411B41EF6E21B035E33EC6EBFFF24C3723AA58CF8A7128235176E8C2A972F1C9AEC426B92D2955DB93C2A748F3F5FA357692DC431F33682F3890889CA4E2714BC0FF30DEC4BFD70230E28E966444FC5EE06764E1EE874E13B145834BB4BE09390A37B71E19479D42532E4C2B6AEC05F7410F77496ECBCA1F1E7D44F9DF030B80A7D336CD2F2F335E153C00ED761A3E6E330E26E8B49C59DAE40A0F7AA9E475E5F21BA56A949ABB7682BE02DE19430837449658568E51A4D2EA5BA4AA881930799DAD063D891F5629101F43538E1545588FA1E86956C07F202DC536A034FE98C523B69E88C52ABEB6456B9EB58CF92729C57E3A9309E96101B3826C510C92AA738A74CEEEFB506BAA5F04DAC0781C95A922FAE0BF4A21D44CB28AFBA01F339A093E527C1793DB34F405E6DFEC7B2F9976D678DCFABAA85198EB3CDCC2B0A94B09AA4A4A7E2C427D3FCDA681D738B471179BEFB84668779A507DC9F23505191CA9B7306C11DF054F91871257DC019DE123FC282BEB699A5F687E5D6BBF5AD8F4296B7DD5B81CCDD7B84F6B2F6FBFA1E2E77AB58782844E8D2C596D49F6953BD2A4B70CC3CABDDE92EBFC030E63667B85574869B831A37B47FD1A6DD78D02C33CB074DADA33C46BFD7DBB555177BC18EC0070956BC67F1BDE488089778BAB5E2C27AE512F4CAC081C5B7A7780A10A8709449DD8553E6D219F15B4D464169180A6229B3F1D49A239801EA3D93ADB6B289206980D085C9C6549672D5CA0D9C82C6D62BB27EF030A951CD29A47CDF96E60CCD35B4E61A6395527E7F8D340AFF0C4A68DC93ADD73B25109B34C3149573B5C8CEAACDD5CD7435B5FDBA562DF933285AF53E6C99962D8F5FD847628FFC784024B92302E27278AC4A6A6EB07279D012C95DB9AA3931EE1864E97C89F96A7EDE53F44653BD3280F9225B4334C6FF154324326637CB1A70D153AFC0CA6F803594CCFA1488C20EAD9C7676182F746A766FA6AA54EB835636D3BA3DD134B7F5D1AA304CA63BAA8328AF5883D5ACB832D0177045786F18E075F933BDAA591C73547F92F550533B7D31EA624E93A853103B37899A0530C499B5669F26999997CBD90DCE92DE90D2201C030F6270466633CCDD0ABC88A4C41A2F4911A35FC7ED0902C112C37145054F2093361B09AD844C41A98DAF033D38A15CC8D46BDBD6C80BB466AA4F37F8AF74B4B2DBD6372C756A69FBF873F2985BCF0FE955AB52BEA42738CB200EA3F18441DB79BDA315B354884F78C525D428F4A38099E3B9B977C22828022445CD31127A401123296A81A1BCF597C094BAE6A8C96D4A11ACF2CD7F0546FAFEAFE0A4C5CDB132064011292B6C8EA332008A706A5D73D4D2055E11B254D11CAF7C8957042CD7E8880347B112ED88A899A676AA2E5B7A233F608CF49B740CA6735B7B4FD118E9895C47727E2FF90EC399DE8C52F3065C04AE69F6AAE08D155C39A36D52AD0B59437B4DAEEBBCCDCA5B15ADDA47A9D20B8C0A955534C74B1E5F8B4849510B5329BEBE964CA558F16A7A8D4D2FCB0B3669746992DDDEE28C3D5FCDADADB9FD4F545BCB2FD526D9E8599EA9E4938324B75B4DBED792BD6513DBC2A57AA05E9CE88DE702B7AB1737E88DBFFA239F427CDB943638238C4E50C196AF9336E6A26F15CAFEF6D0E71D213CBF2237D639F4E5DD7A065E43C4E8D708687C171B6B1E5F8FB1CE1E0877EF09D739EBEB10D22B5117D4E78DF0CDD75E8212F79CC64A9A0334E15F6B04740F3FCB0D10D03BE35413D09BEC4347BE796749AB78240DC1D62619BF40632D11927438ED7D04270B8F43FBCF45FF03EBF48FCF4B881DEB82A3133EB0FAD65F6DB77F2529B86E9A3FA27E9992A35795EA48935B7B52159439C5AFB727C97601A8A0C876827961065199BBBC5AC30BB7862DD7C28D31FDD257C86767D5AD7C9CDE0CBDB0137DC5F85AF65CECBC6D63ACACC3C76BAC614FA45E4502494706E0962B51ED65F796E94D433EDDF7569A8C2FD485C1B7E5EA62BEA6DD42569C4EB430DC6F2BBFA93052DE9677771880EF42DCDD244FBBF3D763C4B521C41905E84AA12B7AB25AFA5CEDD4DB71ECEA2876C661B6958457D69922EDA503A7AE09596F1B5975DD1641D73DF50575AB0873DD26A9E87CE9C5EA491871FACB04FAD5C21F0F42972EE8348788FF941003B7E451B336A76C12A68E5D91286DA2E62B2009E627E490630E465C89D52E08B1F87B1EC9CF918E833BF04ED945246791C4294370E797D83D7180A81B7F41FB2BCB3CB8982D7E05B78929A098344EB12ED88788FAF9CFA84E2A522C03441C793E02962FF712039984E93C433A5FFC9AAB0950B27C59C0BC8660E62398B8606352F8F9580BD96E047C822971E7E903931964F54694977D7044C99493402418797FFC8A3AEC058FEFFE033A1B7F26434B0000 , N'6.1.3-40302')
END


GO
