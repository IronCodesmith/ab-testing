--beginvalidatingquery
	if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_DatabaseVersion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
    begin
		 select 1, 'Upgrading database'
    end
    else
		select -1, 'Not an EPiServer database'
--endvalidatingquery

-- Create MultivariateTest Tables to Store MultivariateTest Information.
DECLARE @CurrentMigration [nvarchar](max)

IF object_id('[dbo].[__MigrationHistory]') IS NOT NULL
    SELECT @CurrentMigration =
        (SELECT TOP (1) 
        [Project1].[MigrationId] AS [MigrationId]
        FROM ( SELECT 
        [Extent1].[MigrationId] AS [MigrationId]
        FROM [dbo].[__MigrationHistory] AS [Extent1]
        WHERE [Extent1].[ContextKey] = N'EPiServer.Marketing.Testing.Dal.Migrations.Configuration'
        )  AS [Project1]
        ORDER BY [Project1].[MigrationId] DESC)

IF @CurrentMigration IS NULL
    SET @CurrentMigration = '0'

IF @CurrentMigration < '201602082034580_Initial'
BEGIN
    CREATE TABLE [dbo].[tblABTest] (
        [Id] [uniqueidentifier] NOT NULL,
        [Title] [nvarchar](255) NOT NULL,
        [Owner] [nvarchar](100) NOT NULL,
        [OriginalItemId] [uniqueidentifier] NOT NULL,
        [State] [int],
        [StartDate] [datetime] NOT NULL,
        [EndDate] [datetime] NOT NULL,
        [LastModifiedBy] [nvarchar](100),
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABTest] PRIMARY KEY ([Id])
    )
    CREATE TABLE [dbo].[tblABConversion] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [ConversionString] [nvarchar](max) NOT NULL,
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABConversion] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblABConversion]([TestId])
    CREATE TABLE [dbo].[tblABKeyPerformanceIndicator] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [KeyPerformanceIndicatorId] [uniqueidentifier],
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABKeyPerformanceIndicator] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblABKeyPerformanceIndicator]([TestId])
    CREATE TABLE [dbo].[tblABTestResult] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [ItemId] [uniqueidentifier] NOT NULL,
        [Views] [int] NOT NULL,
        [Conversions] [int] NOT NULL,
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABTestResult] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblABTestResult]([TestId])
    CREATE TABLE [dbo].[tblABVariant] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [ItemId] [uniqueidentifier] NOT NULL,
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABVariant] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblABVariant]([TestId])
    ALTER TABLE [dbo].[tblABConversion] ADD CONSTRAINT [FK_dbo.tblABConversion_dbo.tblABTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblABTest] ([Id]) ON DELETE CASCADE
    ALTER TABLE [dbo].[tblABKeyPerformanceIndicator] ADD CONSTRAINT [FK_dbo.tblABKeyPerformanceIndicator_dbo.tblABTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblABTest] ([Id]) ON DELETE CASCADE
    ALTER TABLE [dbo].[tblABTestResult] ADD CONSTRAINT [FK_dbo.tblABTestResult_dbo.tblABTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblABTest] ([Id]) ON DELETE CASCADE
    ALTER TABLE [dbo].[tblABVariant] ADD CONSTRAINT [FK_dbo.tblABVariant_dbo.tblABTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblABTest] ([Id]) ON DELETE CASCADE
    CREATE TABLE [dbo].[__MigrationHistory] (
        [MigrationId] [nvarchar](150) NOT NULL,
        [ContextKey] [nvarchar](300) NOT NULL,
        [Model] [varbinary](max) NOT NULL,
        [ProductVersion] [nvarchar](32) NOT NULL,
        CONSTRAINT [PK_dbo.__MigrationHistory] PRIMARY KEY ([MigrationId], [ContextKey])
    )
    INSERT [dbo].[__MigrationHistory]([MigrationId], [ContextKey], [Model], [ProductVersion])
    VALUES (N'201602082034580_Initial', N'EPiServer.Marketing.Testing.Dal.Migrations.Configuration',  0x1F8B0800000000000400ED5CDD6EE33616BE5FA0EF20E86ABB985A4E0605BA81DD22E32445B093C920CE0CF66EC048B44354A25C914A632CFA64BDE823F515F6C8D61F4951A27E922853A317CDF0E72379F81DF290FAE8BFFEF873F6D363E05B0F386224A473FB6832B52D4CDDD023743DB763BEFAEE07FBA71FBFF9C7ECDC0B1EADCF59B9B74939A849D9DCBEE77C73E238CCBDC701629380B851C8C2159FB861E0202F748EA7D37F3B47470E06081BB02C6B7613534E02BCFB07FC731152176F788CFCABD0C33E4BD32167B943B53EA000B30D72F1DC3EFF489638821E4FAE50F40BE6D0D1C92D66BBFF9F21DFB64E7D82A05B4BECAF6C0B511A72C4A1D3279F185EF228A4EBE50612907FBBDD6028B7423EC3E9604E8AE2A6E39A1E27E3728A8A19941B331E062D018FDEA68672E4EA9DCC6DE78604539E83C9F93619F5CE9C73FBF45D6237DB929B3A59F85152ACDED6BB999AEC31DE588D25DFE4E4994E76FFBDB116B1CFE308CF298E7984A0C4C7F8CE27EE7FF0F636FC05D3398D7DBF3C021803E4090990F4310A3738E2DB1BBC4AC775E9D99623D673E48A79B5529DFD987F8E09FCFD01DA46773ECEF9E1D456BF25DCC71902B00C866D5B57E8F13DA66B7E3FB78FBFFFDEB62EC823F6B29414F61325E06C508947316EDDECF56F144735CD1E4DA74FD26C44D68422FF92E3A0A7E19640B9C270E0B23BD6A4A98D55237E56AA9EFC7D0BAB4AEB4E9C536F109CF78871203B5911ECBDDB0E302FF5CD2D220C3D1DA6EB59B7BB817D400F64BD5B3BE42E8634DD5B986DDD607F5786DD934D3AD945FE976C35BA88C2E026F485CA69E6975B14AD3194B90D752596611CB92D3A08EBC2471CADC208D63F175F528FB8888751756F35852BBA5E5F52194743F1B6834A2ADD6006CB6BF5388AFC8AAE2B994A6FD5126D3BF8194504514DEFD2CC8AAE89394ABFA4ECAA4ECD9C6217ACDD1B0B66F5DB1F0B9CC31E0943ED095158335B54B54B2CFCF9145BDF2B587333BFE9BFDC661EA45F6E3317ECE4639A55AF9FC369400FDED7DFFB34A69551BF66071A2C02905DCB3060E8E467C57EDDCFB50A9C8337F5F7A6010E4F9F09FE8D65089794BF3DEEB1A3F6057AD57EDD322296BD571F337772D83490EDE7AD29C8C15547E1AAAFDB3D8C8F64B263684E6C665E1107D226965E0B5DB20B1FAD8BABDB3E5E92B4C28A3BA727F41638787838F2B700545E67C5C9B9C2C11D8E32DA51E472F20023FC8CFC1812A6CA640AE54FC5D247F5A5CF425A943D6E408EDC7B80F6F2F26FD539DCCF5639F194B1D025BB2951769B8C4A62A3E7D4B31A0F23C55561F9907E057340366075A0D2DCFE97329E3AE8FC22A180CE982EC21ED9F212774DCFB08F39B612E32797FC0BC45CE4A96E0716F2C4145815718469F22902BAC480398472750925D4251BE437755EAA68B8FA261DCB9B9073CEF0060367296F9A1393B6B365586D3F6F463258937D664E8960F5BC6B08DB754C318DE10BDA688FB4E6F434BD3A1C3F57CD46F20CC4359BC7D1B3580D52751CAA8958C50F2DD9B1D09C9E35D7C3E367A4B6F3CF4042ED9C8C9E7752F4A763862E142C68919F6BCCE9A6BBF21F3FD7AA7BFE0C44AB9E8791B16C1FF3431D0E358A9814717487184ED2F163D501F81364EEA37B96DEE0CBCC497097980B871A665BC52143E28D423D1140B8205140CA11680390FE4BA382AA8D221A9A48079B7FFA5380CB4B7E0356F1894E41C9DD5882284D7595FDF2D363A99CF6BB84CC409393413E0469D6143A9B9C054A603987E485421CB081319AAE8F55CBB4895CBBC4AEA561EA095A6340C368F549AC597169A71AB02168320C9BD4FEE74E56631C7DACF424F6906F695463D4EDE4267B79A9DBC5FA506300CDEEDD6BF4D97D51BE77E4793367AF164C13668E465638BB429B0DA1EB92CC304DB1967B8DE1E2BB657BBD5DB0C7705C5621BBCB7B9BB7045E82D658CA4D56240F5F9088F16C2FB4AD851728C5E49D52B39867AD899BA13A61D90A9F954FFE4EB551F572CB4935950A935EC02883243849068C9599572B5A89E813F928AAB8065E847E1C507D94A4AF9D0AF4CA0069923946AAB62B63A4492D3024E99C0026E599A3A617A365B04A095D034626A79370B26473AC5C505746CA13CD7164415D194ECE334715EEE2CB904286399E781F5F06147354C49923798912782BAEA99C55444F375A07CAD1D1906B41291A6EBF1ED4557EA235213DEE088B82E60854C326459324504AC93DF0D498A7DA887448D2EA0E5BED196C8C34663AD7887CCAC035C50E043726B874961892D6A5A37E7B26D7551E3379ABA2AAF6D1542AAB2983A4495D7605A6DB10DAE1FDDD5D253F6F0EE924D94D567B0FD1D6FCFADDE36F4245E59E412E92B79EDF3748F70AB3F48CDFFCA65139F4EF8BD81698EA8178C9817FB965305393A4C064F9ABBFF0094EAE60B3025788921510622F38B18FA7D31FA49790E37995E830E6F9157724EAD34471B69E41611653F26B8C49F2A523615ED4EF21207D40917B8F22F529609F777E95A8BB1765833CE3EB6D02E1491F49485A00983C6B53DEF579F0371FE05D5F679CEA777D26F3D0F1195FE79E5649030DC1BA3C8D7A85FE29A8415538E583231C6DF0E3DCFEDFAEFE8975F9DF2F7B8837D67504EBEE8935B57E1FEC1D5346A97F06E8F1DB2134A6A32692D179F9C0AAE1DEE7D48DF36B5CA974C7D803A73A4ADF7B0F4A78B122C5065DDFAB748279654CAE3C6E1E68FC52341E397DFA08EF33F1C0F32AECAA14399DA5FE9DE47ADAEFD84F28A31F9B286F30E1FC4B93482BA01B42AA3F727A997FCF1A19D7CCE5ED2F4DAFB28CB2A3A07EE424AAFD7A3432DE18CAD35F9A34B96AB68B207EE474D17F4719A1C85C55D8C95356A5AAAE5190EF2FEB216ABB0B6176D3E3F49DDF5A60DEA02FD736D35F84DE4683AEED4657D57A79D9AC55ACD7DAB99DACBD4ED5AE6DE66575EF220DCB124A3381BB461FFFBA54EDDD8CD0C0FA5AF1CE0865EADD8CA0BA992CF5189502BDDB2025F7163ED53F89C45CFDC40BFB55E9C76D61AB64645D40243F754BB12BEC5479994BBA0AB30D53EA515644BE3CC01C79B08D9D469CAC90CB21DBC58CED3E29A44FF5CF833BEC5DD2EB986F620E43C6C19D2FC865938DB7AEFD9D8E5EECF3EC7AB3FB8588218600DD24C97DC7357D1713BFF889818B8AFB0E0D44B2A3FF8C217D3F97102070BCDEE6481F76BF746002949A2F0F446E71B0F1018C5DD3252AFDB4428BBE7D62F83D5E23779B7DA9D783344F8468F6D91941EB08052CC528EAC33F81C35EF0F8E3FF016A321990E3590000 , N'6.1.3-40302')
END


GO
