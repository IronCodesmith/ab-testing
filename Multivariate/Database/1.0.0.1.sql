--beginvalidatingquery
	if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_DatabaseVersion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
    begin
		 select 1, 'Upgrading database'
    end
    else
		select -1, 'Not an EPiServer database'
--endvalidatingquery

-- Create MultivariateTest Tables to Store MultivariateTest Information.
DECLARE @CurrentMigration [nvarchar](max)

IF object_id('[dbo].[__MigrationHistory]') IS NOT NULL
    SELECT @CurrentMigration =
        (SELECT TOP (1) 
        [Project1].[MigrationId] AS [MigrationId]
        FROM ( SELECT 
        [Extent1].[MigrationId] AS [MigrationId]
        FROM [dbo].[__MigrationHistory] AS [Extent1]
        WHERE [Extent1].[ContextKey] = N'EPiServer.Marketing.Testing.Dal.Migrations.Configuration'
        )  AS [Project1]
        ORDER BY [Project1].[MigrationId] DESC)

IF @CurrentMigration IS NULL
    SET @CurrentMigration = '0'

IF @CurrentMigration < '201602112046201_Initial'
BEGIN
    CREATE TABLE [dbo].[tblABTest] (
        [Id] [uniqueidentifier] NOT NULL,
        [Title] [nvarchar](255) NOT NULL,
        [Owner] [nvarchar](100) NOT NULL,
        [OriginalItemId] [uniqueidentifier] NOT NULL,
        [State] [int],
        [StartDate] [datetime] NOT NULL,
        [EndDate] [datetime] NOT NULL,
        [LastModifiedBy] [nvarchar](100),
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABTest] PRIMARY KEY ([Id])
    )
    CREATE TABLE [dbo].[tblABKeyPerformanceIndicator] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier],
        [KeyPerformanceIndicatorId] [uniqueidentifier],
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABKeyPerformanceIndicator] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblABKeyPerformanceIndicator]([TestId])
    CREATE TABLE [dbo].[tblABTestResult] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [ItemId] [uniqueidentifier] NOT NULL,
        [Views] [int] NOT NULL,
        [Conversions] [int] NOT NULL,
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABTestResult] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblABTestResult]([TestId])
    CREATE TABLE [dbo].[tblABVariant] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [ItemId] [uniqueidentifier] NOT NULL,
        [ItemVersion] [int],
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABVariant] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblABVariant]([TestId])
    ALTER TABLE [dbo].[tblABKeyPerformanceIndicator] ADD CONSTRAINT [FK_dbo.tblABKeyPerformanceIndicator_dbo.tblABTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblABTest] ([Id]) ON DELETE CASCADE
    ALTER TABLE [dbo].[tblABTestResult] ADD CONSTRAINT [FK_dbo.tblABTestResult_dbo.tblABTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblABTest] ([Id]) ON DELETE CASCADE
    ALTER TABLE [dbo].[tblABVariant] ADD CONSTRAINT [FK_dbo.tblABVariant_dbo.tblABTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblABTest] ([Id]) ON DELETE CASCADE
	IF object_id('[dbo].[__MigrationHistory]') IS NULL
	BEGIN
		CREATE TABLE [dbo].[__MigrationHistory] (
			[MigrationId] [nvarchar](150) NOT NULL,
			[ContextKey] [nvarchar](300) NOT NULL,
			[Model] [varbinary](max) NOT NULL,
			[ProductVersion] [nvarchar](32) NOT NULL,
			CONSTRAINT [PK_dbo.__MigrationHistory] PRIMARY KEY ([MigrationId], [ContextKey])
		)
	END
    INSERT [dbo].[__MigrationHistory]([MigrationId], [ContextKey], [Model], [ProductVersion])
    VALUES (N'201602112046201_Initial', N'EPiServer.Marketing.Testing.Dal.Migrations.Configuration',  0x1F8B0800000000000400ED5CDD6EDB3614BE1FB077107439B496D3A24017D82D52272982354D11A7C5EE0A463A76884A944B52698C614FB68B3DD25E6147B6FE488AB2243BA95B04BDA8CD9F8F87E4770EFF3EE7BF7FFE1DBDBE8B42E716B8A0311BBB0783A1EB00F3E380B2F9D84DE4ECE94BF7F5AB5F7F199D04D19DF3292FF73C2D87359918BB37522E0E3D4FF83710113188A8CF6311CFE4C08F238F04B1F76C38FCDD3B38F000215CC4729CD165C2248D60F505BF4E62E6C34226243C8F030845968E39D315AAF39E442016C487B17BF2814E81A3C58373C2BF80444307572056FF1F93D0758E424AD0AC298433D7218CC5924834FAF0A380A9E4319B4F179840C2ABE502B0DC8C8402B2CE1C96C5DBF66BF82CED975756CCA1FC44C838EA0878F03C1B284FAFDE6BB8DD622071284F70C8E532EDF56A38C7EED19B74DC5C476FEA7012F2B458F358AF666AB0C678E26C2CF9A420CF70B0FAF7C49924A14C388C192492132CF121B90EA9FF072CAFE22FC0C62C09C36A0FB00F98A72460D2071E2F80CBE525CCB27E9D05AEE3A9F53CBD6251AD5267DDE7B709C5CFEFB16D721D42C10FAFB1FA159521E408C832ECB6EB9C93BB77C0E6F266EC3E7BF1C2754EE91D04794A06FB91517436AC2479029D9BBDF8C68037347B301CDE4BB39CCE2923E1998468CB819B22E5CA8143975DB1264BDD5895CBE34AF5F4F3154695CE469CB0602738EF889048763AA310BC59EE605E9A9B9B70404B77637A6E763FB0F7E496CE57B1438345B7FB007C16730C2F3E9CB180FA44C65CB8CE2584AB0AE2862EB299B714FE9CC7A9531E4797716887CD4A7EBE227C0E58E12A6E557C1A27DCEFD0A9B4D225088C5EF5FD28F36B4C37320D6BCD125D0DFC443825CC625D9659639A9A63D8A565D71935F2CA45A671E9B1CCC8766B9105F47171C2AEEA10CD352C23D90DE407084FB90FDC6730CAFDA46530CABDAE975B95A1633B4F2A711E9DA7C6793A42EC609BF489C23791239C31F9FC5967083C6365C7BC6D817E68BFEEB838EBDE6B5FBE7B396CB6A66EE7AD19C8A3ABEE85ABA610D9286B7EF633BB55EB5DA5EE50964D673B6F4A226DF1CB0E8E67E23424F3F272671BEF4A5B11E5A9F41EBD0C4F7F01F070894055DEA893730ED135F09C6B8CF892DE620F3F9130C184A131994AF923B5F44173E9E39895654DFEAAC8DCBF41E8A028FFDC9CC3F56C55138F84887DBA9A92E69D67CE2BD5023CB73BDDF660E53583F504728E5345173839C8B8B1FB9BD1EDD68D16E7A7B2D1DC3BD4368683C181AB47D40B760C214870D2394B6F0F2744F82430BD15073650533008030796DE71E2A22F90709449336253E6D305093B7546436919F9532B8BF6F49C635800F29EC94E53D9C6907C3D308D29DAD48672D3C88DBC0A639B896CEE336C346AD874A8B762F9CEBE3D431B2E1B3691F2FB33D26AFC0390D03A277BCF3B6D21B631C3B62A97B428B6A6EDE966BB40DA7FAED55BFE0044AB9F873D63D97AFB857524D628B70744926B22204D87BBBA33CC47CC5C6FB44476A3AD3327C59D8254F697783C2DF77B1A6F0CEAA900F6EB6603D1BAFE6F6822B3B1B8FF3580AB917A0356794F6BA014DEA74154666863B78BCD78A552BBDB2D9D529D375A454F9BE6C4606EE7AD55A599823B7A805047ACC568D6DC109803B861796FB9C09BF617BC6A181CFBAA7E2FE3A11FEDCCC1685A73DAAC3A15B34B97681800CB3AB355EFF3436611E54A0D82B71621E46205CFA256189D93C502CF6E15F54296E24CD7D285C9D369F767FC688DE1F9A2E635BFB0B66809BD84CC41CB4D6FFF0238A55CC83C6ABBCE24888C627A4CB7C4AFBC35356C9B139607B5BC7CFA397B726D56710CEAA9540EE929F6324A97D1B4C360CCBC59D149B5242424BCE6CE69128749C4ECEBB9BD76F6EE5F05C892DA63648FF8558C2CA90386F622AF806979ED51B3DB942A58EDCBFC068CFC955EC3C993DB6315EFF455A422B13D8EFE4E5F85D3F3DAA32A1778554825A33D9E7A89570554734CC491A77989B145345CD3D855AB9EDE2A0E5857FA5D0606DBBEAD7BA4688D744FA123DBBF2BB1C3B2A7B7A334BCD456811B8A3D12BC35C1B53DDA2E695D393574677253E57D266FDD6AD57D95CADE46AB205952076A571F47156A57331E5DA5B5AB14FBF85D3A497E28EEEE21D69A3FBF7B28EF913A5491F1486D2DDB380FEA458AD68B73A176FE1B6567B1CD9276E370B62EE23A3854B734480F66D3A5C0E91AA40506D3AFE124A490DE0EE505CE09A33324D8FA35D1C5B3E34B4D08BF3FA2744F8820AC39CB9ACA7475B61E40769030FA35019ADE9DA6CCE3DBE9C0D92DE1FE0DE1A6127C1B99772DEA4A50BC1315F7D643A028BA694AD212A08DAAD9907507F859EE40D6DD1BA75ED6DD661E7AAAB87B5B5AA7FB6809B6B574F7077456452F64C219EF19D859B81BBB7FADEA1F3A677F7E5E433C712E3806E14367E8FCDD75FA374A6D9BBAF933F2CB769879A4544F15DBD69D52C4A75A44EF2B3DED05F38331B9F6D0F148E3EF45E31A61668FEDC99E9370678ABAFCB5EFC1D56B1B1F817723E3EB2513B1BE4A3D940A6EDF9421DBE8DE5A33EC9EE855156AF454DAED39891A2F95F78C372D756BDF9B34852EA78F526ECFE962BF5EDD43F5992968B0DC4B6BBF5DB04ACBD6776EB8005FC738BBD986E03ADC4E79D645786635A0AF54AD1AC91A656A8D5DEFA6656B92B2599BD957B19BCA99AABCA48776AD8D286E1FD56BFD06C1E49EFE52B957C2B47E9DD438AFBC34DD8BF2CC7C51C0B85AF9533A18D2059D9710E91FD661E02B11B52873C666711ED8358BF222FA790524C1F30939E2780423BEC46C1F8458FD758BEC673F27D1350467EC22918B44629721BA0E15154DBA4034B5BF92D7A9368F2E16AB5F9BEDA20B68264D8F5817EC4D42C3F2E74AA735472C0B44BAF2BC054C5FCF252E6412E6CB02E9FDEA57536D80B2E12B16CC2B88162182890B3625959F6975B0EDA380773027FE327F18B2836C9E0875D847C794CC3989448651D6C7AFC8E120BA7BF53F53782C28514A0000 , N'6.1.3-40302')
END


GO
