--beginvalidatingquery
	if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_DatabaseVersion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
    begin
		 select 1, 'Upgrading database'
    end
    else
		select -1, 'Not an EPiServer database'
--endvalidatingquery

-- Create MultivariateTest Tables to Store MultivariateTest Information.
DECLARE @CurrentMigration [nvarchar](max)

IF object_id('[dbo].[__MigrationHistory]') IS NOT NULL
    SELECT @CurrentMigration =
        (SELECT TOP (1) 
        [Project1].[MigrationId] AS [MigrationId]
        FROM ( SELECT 
        [Extent1].[MigrationId] AS [MigrationId]
        FROM [dbo].[__MigrationHistory] AS [Extent1]
        WHERE [Extent1].[ContextKey] = N'EPiServer.Marketing.Testing.Dal.Migrations.Configuration'
        )  AS [Project1]
        ORDER BY [Project1].[MigrationId] DESC)

IF @CurrentMigration IS NULL
    SET @CurrentMigration = '0'

IF @CurrentMigration < '201602221937207_Initial'
BEGIN
    CREATE TABLE [dbo].[tblABTest] (
        [Id] [uniqueidentifier] NOT NULL,
        [Title] [nvarchar](255) NOT NULL,
        [Owner] [nvarchar](100) NOT NULL,
        [OriginalItemId] [uniqueidentifier] NOT NULL,
        [State] [int],
        [StartDate] [datetime] NOT NULL,
        [EndDate] [datetime] NOT NULL,
        [ParticipationPercentage] [int] NOT NULL,
        [LastModifiedBy] [nvarchar](100),
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABTest] PRIMARY KEY ([Id])
    )
    CREATE TABLE [dbo].[tblABKeyPerformanceIndicator] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier],
        [KeyPerformanceIndicatorId] [uniqueidentifier],
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABKeyPerformanceIndicator] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblABKeyPerformanceIndicator]([TestId])
    CREATE TABLE [dbo].[tblABTestResult] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [ItemId] [uniqueidentifier] NOT NULL,
        [ItemVersion] [int] NOT NULL,
        [Views] [int] NOT NULL,
        [Conversions] [int] NOT NULL,
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABTestResult] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblABTestResult]([TestId])
    CREATE TABLE [dbo].[tblABVariant] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [ItemId] [uniqueidentifier] NOT NULL,
        [ItemVersion] [int] NOT NULL,
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABVariant] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblABVariant]([TestId])
    ALTER TABLE [dbo].[tblABKeyPerformanceIndicator] ADD CONSTRAINT [FK_dbo.tblABKeyPerformanceIndicator_dbo.tblABTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblABTest] ([Id]) ON DELETE CASCADE
    ALTER TABLE [dbo].[tblABTestResult] ADD CONSTRAINT [FK_dbo.tblABTestResult_dbo.tblABTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblABTest] ([Id]) ON DELETE CASCADE
    ALTER TABLE [dbo].[tblABVariant] ADD CONSTRAINT [FK_dbo.tblABVariant_dbo.tblABTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblABTest] ([Id]) ON DELETE CASCADE
	IF object_id('[dbo].[__MigrationHistory]') IS NULL
	BEGIN
		CREATE TABLE [dbo].[__MigrationHistory] (
			[MigrationId] [nvarchar](150) NOT NULL,
			[ContextKey] [nvarchar](300) NOT NULL,
			[Model] [varbinary](max) NOT NULL,
			[ProductVersion] [nvarchar](32) NOT NULL,
			CONSTRAINT [PK_dbo.__MigrationHistory] PRIMARY KEY ([MigrationId], [ContextKey])
		)
	END
    INSERT [dbo].[__MigrationHistory]([MigrationId], [ContextKey], [Model], [ProductVersion])
    VALUES (N'201602221937207_Initial', N'EPiServer.Marketing.Testing.Dal.Migrations.Configuration',  0x1F8B0800000000000400ED5CDD6EE33616BE2FB0EF20E87231B59C0C0AB481DD22E32445D0C924883383BD1B30D2B14354A25C914A63147DB2BDD847DA57D8235B7F244599929CD4E9067331097F3EF21C9E73C8437ECA7FFFFD9FC94F4F51E83C42C269CCA6EED168EC3AC0FC38A06C397553B1F8F67BF7A71FFFF1CDE43C889E9C2F45BBF7593BECC9F8D47D106275E279DC7F8088F05144FD24E6F1428CFC38F248107BC7E3F10FDED1910708E12296E34C6E532668049B5FF0D759CC7C5889948457710021CFCBB166BE41753E9108F88AF83075CF6FE81C129CF1E88A24BF82C0898EEE806FFE3F23A1EB9C8694E0B4E6102E5C8730160B2270D2279F39CC4512B3E57C850524BC5BAF00DB2D48C82117E6A46A6E2BD7F83893CBAB3A16507ECA451C75043C7A9F2BCA53BBF752B75B2A1255798E2A17EB4CEA8D3AA7EEE9874C6FAEA30E75320B93AC59BBAE372B35DA62BC7376B67C571ACF78B4F9F7CE99A5A148139832484542B0C54D7A1F52FF1758DFC5BF029BB2340CEB12A00C58271560D14D12AF2011EB5B58E4725D06AEE3C9FD3CB563D9ADD6672BF3CF29C59F3FE1D8E43E84D23EBCD6EE7754845020A095A1D8AE73459E3E025B8A87A97BFCDD77AE73419F20284A72D8CF8CA2B3612791A4D079D8EBDF19242DC31E8DC7CF326C42979491F052403450717334B94A71E8B21BABC94B77764DC459AD7BF6F31D4695CE933867C15E706E7042D4A7AB8D17DD40E203136459E25E32F1FEB833E847C2057A105D50083EACF7B0D8EDC3CD1240F1F7A38F62DAFDC03E9147BADCAA5286455F46E52EE20463960F972CA03E1171C25DE716C24D07FE4057B939191A7F2D82DF451247B7716886CD5B7EBD23C912B0C35D6CD57C1EA7B8FEF642659D6E8163486C96A3AA6F98BA56A9CD566FD175825F48420933CC2EAF6C989A5CA3CD4BA96E9AD4C4AB76AED6FDCCB022C3363803E8DB8E87A2AA10ED3D0C9AEC06F20AC253E103CF198C0A3FB10C4685D7F572AB2A740CF3A40AE7CD791A9CA723C41ECE5E1944AEE56147942F147EE7C3203003CC93D0A140AF3A4074DCE5D530603E07F4F2FC7C731EE6F639C89BCFFFBD7CFE75FB99F57955F530C371D6CEBDD248D956F33CF7925F846459DD450D71B76C145E25D1CFE87698570690846B04AA1B92BC385710DD4352181F23BEA08F28E11712A65830D616536A7F2AB73E6A6F7D16B3AAEDF10EE4C47F40E8A06CFF5E5FC3ED6AD50B4F398F7DBA5992F6336D6157F20CCE59E0743BDD55B722C6DCE60A978AAE7071D0E2A6EE3F35B1AD072D33B36AD0C23BE431C6A3D191AB86D86B7606210870B235CB2E3B6784FB24D0BD15151BC82518952101965DC9E22980A3C15126F4104E5976B31276124641B1DC0AB25996E3A93567B002B47B263A2DA5CD448A0D429F4C39A6A2CA5D9A9B78358B6D3764FDE06132A39653887C8957E40CF616DA728DB1CB28FF7A8B344EFE058CD0B826076F77CA466CB20CD3AE5C99457956B53737D3D5D4E1DB5AF3CC5FC0D09AD7E1C0AC6C7BFCC23E027B54C70322C83DE19095C3535352F3192BB7072D9EDF95AB9693E1CE4148E74BCC57ABF39E62379AE9C900E68B6C0DD1B8FFEF18229F6379B3AC01D723F50EACEA06584329BD4F81A8ADD04EB1CBC378AD93DDBD996A529D0F5AA5A46D6BA2596EE7A3556D98D276D400216BCC429B0D5706BA02776CEF961BBC3EFFD2AE5A9463DED59F451F6A6AA72BA36DCFB1D9756AD3AE5CA24501867D6690F445925946B98A32E16D391305B7C233902B265764B5C2DCAD46B6C84B9CF9966931FB76DE9D75106D313C9F37900FCAD99623A197902528B5D97560001734E1A288DAAE330B22AD991AD30DF1AB184D0EDBFA821541AD689FFD9CBF10B7934E46CDA654A9F402A58CB26D341318B495D73B3A19F585842469B8849AC5611A31F37E6EEE9DD314EA0079913D46CE39A863E4451D3014028104A6D4D9A3E6B72975B04622C10E8C8254A0E014C5F65825ADA08E5416DAE3186905755C6323FB7154A6411D5EADB347952E0AEB9052853D9E7C595807946B74C489A778A37614D54280767A97238A55BC319E28F619804CE7C3EE11C91AE99942549E274831CA903B98515ADE9AEBC02DCDDE0CDCDAC095B3E03ECDBA969D74B7E4B6CE876CBC4DBB62F7DD507AE951A1CA0A7BBCFC91B78E9417757095FA2BAFE42AF58A37D7B376BD32FFD8A7D315C97C778F33F67C73B7AEEEF67F62DA5A1EAB3629472FF359256F9DE439E4EE2F07B4A472DBC47550558F34C812CAF99AE3728DB206A3F96FE12CA490DD6A150DAE08A30B34B0ED2BA88B39EFF7CAF70687C3FDF7380FC2861C5CFF00405EAD17E04FA48CFE9602CDEE7C33CB4B86D1EDD92349FC0792E884FB216CFA46D40DC57A2F64F9C12A9088F33433D20AC086E7ADB1E703FC59EC813DDF1B67077B5E91710077DE66697B52E57B0BDF4481B1041BCC8F7E85FE2F71A97438ED69078585A7A9FBC7A6FF8973F9AFAF5B8877CE758271FDC4193B7F765DFE9D7CE63631FF8EF665CAB7DE4CAA27C36FB0500D6CBF3E6154E2F7F6016860F7F68279650ED1980EBD79C32BF78603B7C2BD91148B07D4172704EE7C57DF0F33B217F3C6F8D0F752C4C24323DB0CA1125A5BD83399579DFBD293BC78E046D47A7F7E6076634905FCAB8DA6A43AF5211F1EB8B9986F7E0F90D0A773440C57E6CAE72046B6DEF63A1037E0FB185737CFD3EEC36164BE2E5C3EE304FAB2FFEA91AC95F9D72A7A377A601B3BD038CCA1F207659BA933767AD0016D7886874808ECA704DDF6D447D983E2FAF51352B179E911EC59C87CFA6307C6D5DA1F53C290CEE9B282C8FEB412035F8AA8659B4BB6888BC0AECCA868A2E62B2008E627E434C11C8CF802AB7DE07CF3A748F22FA9CEA37B082ED9752A56A9409121BA0F25C250B641B48DBF612CCA739E5CAF361FF0ED43049C26CD52AC6BF621A561F505D845438A6580C8769E9F01CBB76B891B9980E5BA44FAB4F910CD0628575FB961DE41B40A118C5FB339A97DF9D6616E9F397C8425F1D7C59B951964F742C86A9F9C51B24C48C4738CAA3FFE8A361C444F3FFE0F58B3B493534C0000 , N'6.1.3-40302')
END


GO
