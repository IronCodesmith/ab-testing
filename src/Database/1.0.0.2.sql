--beginvalidatingquery
	if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_DatabaseVersion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
    begin
		 select 1, 'Upgrading database'
    end
    else
		select -1, 'Not an EPiServer database'
--endvalidatingquery

-- Create MultivariateTest Tables to Store MultivariateTest Information.
DECLARE @CurrentMigration [nvarchar](max)

IF object_id('[dbo].[__MigrationHistory]') IS NOT NULL
    SELECT @CurrentMigration =
        (SELECT TOP (1) 
        [Project1].[MigrationId] AS [MigrationId]
        FROM ( SELECT 
        [Extent1].[MigrationId] AS [MigrationId]
        FROM [dbo].[__MigrationHistory] AS [Extent1]
        WHERE [Extent1].[ContextKey] = N'EPiServer.Marketing.KPI.Migrations.Configuration'
        )  AS [Project1]
        ORDER BY [Project1].[MigrationId] DESC)

IF @CurrentMigration IS NULL
    SET @CurrentMigration = '0'

IF @CurrentMigration < '201602241411152_Initial'
BEGIN
    CREATE TABLE [dbo].[tblKeyPerformaceIndicator] (
        [Id] [uniqueidentifier] NOT NULL,
        [Name] [nvarchar](max) NOT NULL,
        [Weight] [int],
        [Value] [nvarchar](max) NOT NULL,
        [LandingPage] [uniqueidentifier] NOT NULL,
        [RunAt] [int] NOT NULL,
        [ClientScripts] [nvarchar](max),
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblKeyPerformaceIndicator] PRIMARY KEY ([Id])
    )
	IF object_id('[dbo].[__MigrationHistory]') IS NULL
	BEGIN
		CREATE TABLE [dbo].[__MigrationHistory] (
			[MigrationId] [nvarchar](150) NOT NULL,
			[ContextKey] [nvarchar](300) NOT NULL,
			[Model] [varbinary](max) NOT NULL,
			[ProductVersion] [nvarchar](32) NOT NULL,
			CONSTRAINT [PK_dbo.__MigrationHistory] PRIMARY KEY ([MigrationId], [ContextKey])
		)
	END
    INSERT [dbo].[__MigrationHistory]([MigrationId], [ContextKey], [Model], [ProductVersion])
    VALUES (N'201602241411152_Initial', N'EPiServer.Marketing.KPI.Migrations.Configuration',  0x1F8B0800000000000400CD58CD6EDB3810BE2FB0EF20F0B40BA4A6935CBA81DC22EB2485913831AAB47BA6A5B14394A254920AEC67DBC33ED2BEC20E25EAD7FF76D02E0C181239F371E6E37066A87FFFFEC7FFB88885F70A4AF3440EC879AF4F3C90611271391F90CCCCDEBD271F3FFCFA8B7F1BC50BEF6B297769E55053EA01793126BDA254872F1033DD8B79A8129DCC4C2F4C62CAA2845EF4FB7FD0F3730A084110CBF3FCCF99343C86FC055F87890C21351913E32402A1DD38CE0439AAF7C862D0290B61406E273C008516F7C64C7D038386F6EE27A3DE0D13C4BB169CA149018819F198948961060DBEFAA221302A91F320C501269E9729A0DC8C090DCE91AB5A7C5F9FFA17D6275A2B965061A64D121F08787EE948A25DF5A3A826158948E32DD26D96D6EB9CCA01B94F39F1BAEB5C0D85B2329B49CEB7A787CA67DE0691B32A483096ECEFCC1B66C2640A061232A39838F326D954F0F01E96CFC93790039909D1B416EDC5B9D6000E4D54928232CBCF30733E8C22E2D1B61EED2A566A0D9DC2C54F19C7E7475C9B4D0554B140B7AADBFF1200030A7D26DE982D1E40CECDCB80E023F1EEF802A272C4A17E911CCF142A1995C1C1ABFE057CFE62CA7547D25C5EEC52F9CA44F6132C7D60D2668E099BC3493C637EB8AE1CB6A7B9E7460EC4190A0ED204A1E2A9D16F40C78ED5143003D10DFE956BD9E7671E1FCE249E343EE34781F9B43EEEED2490C58D14E0181DE93BC1E675323C362958745D6CD39B2707DC86089458224CF30CB4091C433C05E59C2B56275E7E0E06A4BF42774BBA08934AFA7C95CF82B9D5948A95CB302E2B24DC2236651AEC382CCC1A3AB1143946B58BAAB661056E00A6CED418B9F58EBAF39027F075BB5E595417515A54D1B2DAD20DE5D61FB334458A1BE5D78D7841517B87EF82C36B515C60D050AF294995B5D54A2651983D3AB3B8345A7AC7953625C3C41B46F18A5897FF0DDC96AB3528EED69B9AF152D83E170A5B7A907C633A58359177E85B8CA196BB099539453D5ED1CAFB1F26985A53C48689C862B9A9106ED32E6A5853BF18D91FA1AC474D8C726C7F1457A29A206E687F8C56BD6922B526F6C77339B189E486F6C7E8D49C265667EA00CC666569213627F6C76B579726607B6615D1A79D50EE9E1BBA72703A2D5AF7106ECB615D916AF52A97757296EFF2C7EE7BC44A422944888754BDF2C8269360A90DC43D2BD00BBE8BB24A94026326F90CB4290A15C17CF7BE7303F9FFDC06A8D691D87D25F8E15D7826F9F70C904DB406C34E9DD491CB57A6C217A67E8BD9E2F713BB6C2E5BDDE63EED5FABE73ECD96357DF4C94CB57AEA8E7BC737D31BFD3CB2618EF0D9BC55C3BC27D8E686795D8BB7DA89EC6CE036F56F45CA413BA7099AEC789B0A3C3E1350B344C598A946180921C3AC7674BBB79A127DDAFC00E3DF80E6F31AC27E8E9110DA5C5383963223394B4AE6D1C7A645A5487763C030DC0876AD30705968703A04ADF32B986BB86FB1178F46F229336966AEB5C6DE5C2C9BFEFA74FBFA794FDBB6D97F4AED9B7E0B17D04C6E63E949FE9971115576DFAD89A50D10366A3E018EE7391CAFA008375F56488F89DC13C8D1770329489B0C9E214E0582E92719B05738C636BC923CC09C85CBB2B26D06D9BD116DDAFD1BCEE68AC5DA61D4FAF6A322B55F153FFC079E06393187140000 , N'6.1.3-40302')
END


GO
