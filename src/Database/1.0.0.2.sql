--beginvalidatingquery
	if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_DatabaseVersion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
    begin
		 select 1, 'Upgrading database'
    end
    else
		select -1, 'Not an EPiServer database'
--endvalidatingquery

-- Create MultivariateTest Tables to Store MultivariateTest Information.
DECLARE @CurrentMigration [nvarchar](max)

IF object_id('[dbo].[__MigrationHistory]') IS NOT NULL
    SELECT @CurrentMigration =
        (SELECT TOP (1) 
        [Project1].[MigrationId] AS [MigrationId]
        FROM ( SELECT 
        [Extent1].[MigrationId] AS [MigrationId]
        FROM [dbo].[__MigrationHistory] AS [Extent1]
        WHERE [Extent1].[ContextKey] = N'KPI.Migrations.Configuration'
        )  AS [Project1]
        ORDER BY [Project1].[MigrationId] DESC)

IF @CurrentMigration IS NULL
    SET @CurrentMigration = '0'

IF @CurrentMigration < '201603241331322_Initial'
BEGIN
    CREATE TABLE [dbo].[tblKeyPerformaceIndicator] (
        [Id] [uniqueidentifier] NOT NULL,
        [Properties] [nvarchar](max) NOT NULL,
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblKeyPerformaceIndicator] PRIMARY KEY ([Id])
    )
	IF object_id('[dbo].[__MigrationHistory]') IS NULL
	BEGIN
		CREATE TABLE [dbo].[__MigrationHistory] (
			[MigrationId] [nvarchar](150) NOT NULL,
			[ContextKey] [nvarchar](300) NOT NULL,
			[Model] [varbinary](max) NOT NULL,
			[ProductVersion] [nvarchar](32) NOT NULL,
			CONSTRAINT [PK_dbo.__MigrationHistory] PRIMARY KEY ([MigrationId], [ContextKey])
		)
	END
    INSERT [dbo].[__MigrationHistory]([MigrationId], [ContextKey], [Model], [ProductVersion])
    VALUES (N'201603241331322_Initial', N'KPI.Migrations.Configuration',  0x1F8B0800000000000400CD57CB6EDB3814DD0F30FF20703503A462D26E3A81DC22B593C2489D1855DA3D2D5D3944F950492AB0BF6D16F349F30B73A9B7E547EC20181401028ABCF7F0DC37FDEFDFFF441F5752044F602CD76A442EC27312804A74CAD572440A97BD794F3E7EF8FDB7E83A95ABE07B23F7CECBA1A6B223F2E85C7E49A94D1E41321B4A9E186D75E6C2444BCA524DDF9E9FFF452F2E28200441AC2088BE16CA7109E5077E8EB54A20770513339D82B0F53E9EC4256A70C724D89C253022D7731E8341C6E18C991FE09068783B9F86132648702538434A31888C044C29ED9843C297DF2CC4CE68B58C73DC60E2619D03CA654C58A80DB9ECC48FB5E9FCADB789768A0D545258A7E5898017EF6A27D1A1FA8B5C4D5A27A21BAFD1DD6EEDAD2E5D3922B73927C1F09ECBB1305EE6A093C3324421029C05B875D62605E68EFF3B0BC6857085819182C21926CE8279B1103CB985F583FE016AA40A21FAEC901F9E6D6CE0D6DCE81C8C5B7F85ACE63C4D494037F5E850B155EBE954267D2E38AEEFF06EB610D0C69E1E54AF3F39D80606D3089D4182195B7D01B5748F23824B12DCF015A4CD4E8DFD4D71AC245472A68093EF1E1B600ED209FE6B2EF7EB07AC9B93B130663CE32F028B68973CDB298595EB185760EA8B10942D9805BF0F2BB723C7B014EB34B3B563369957B831B82E53D1F91D87AABAC3328177F16C19754D84565DA4E936744FBB89662CCF31B8BDF653EF0471D57BC66FE2D36B51561834B13B4AB265DBDEE4B4614B189CE2D5C8F4861BEB1A0F93609CCA2DB1A1FFF7F8B6B9ADE7E261FD751E6F84FDBA5238D41E7C6006589D236FD03609CA9566424BA7EA475B5A65FF6782991D453DD6A2906A5F6338A4DDAFE93E4A7FFF78B48D2AEDC36D1C1C8FB759A97DC0CD936DC4880E9C3C8C28DD0AE9A0990ED3E350750D45DADBDB2A1B54535467F6F3137E2BD52B1112A0AB9E78EAD33C5E5B0732F40261FC538C05477B3B8119533C03EBAA7943B012DF0FDE06BFCE9CA6D6A6E2F961FDBFCFCB42F19F05A037910DA69D7985D9A99E98491E99F943B2D59FAF310F535CBBD79A8747829D360FB7DBF6B3D36EDFB0ABAA00792E3452AEF8B985C088CEC164DA482C9EA94A79C2B0D05E3C1BB7AB34A2FDD77A3401CB971D847FBB2B487CFA77A08DCC5465BAF13CDAD867D4880C03038E6120D815264EC61287C709585B3EB9BE3351F8E12317904ED57DE1F2C25D590B7221D67D7B237AF8FEF201B0C939BACFFD977D0D139026F7B974AF3E155CA42DEF9B1DB9B407C267CD67C0FDB2ADE09313E196EB16E94EAB23816AF74D2007E52BF901642E10CCDEAB983DC14BB8E1FBED0B2C59B26E9AED7E90E703B1E9F668C2D9D230696B8C4EDFFF02A5FE27E887FF00FCBC35F1B40E0000 , N'6.1.3-40302')
END


GO
