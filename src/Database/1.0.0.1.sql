--beginvalidatingquery
	if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_DatabaseVersion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
    begin
		 select 1, 'Upgrading database'
    end
    else
		select -1, 'Not an EPiServer database'
--endvalidatingquery

-- Create MultivariateTest Tables to Store MultivariateTest Information.
DECLARE @CurrentMigration [nvarchar](max)

IF object_id('[dbo].[__MigrationHistory]') IS NOT NULL
    SELECT @CurrentMigration =
        (SELECT TOP (1) 
        [Project1].[MigrationId] AS [MigrationId]
        FROM ( SELECT 
        [Extent1].[MigrationId] AS [MigrationId]
        FROM [dbo].[__MigrationHistory] AS [Extent1]
        WHERE [Extent1].[ContextKey] = N'Testing.Migrations.Configuration'
        )  AS [Project1]
        ORDER BY [Project1].[MigrationId] DESC)

IF @CurrentMigration IS NULL
    SET @CurrentMigration = '0'

IF @CurrentMigration < '201603241337050_Initial'
BEGIN
    CREATE TABLE [dbo].[tblABTest] (
        [Id] [uniqueidentifier] NOT NULL,
        [Title] [nvarchar](255) NOT NULL,
        [Description] [nvarchar](255),
        [Owner] [nvarchar](100) NOT NULL,
        [OriginalItemId] [uniqueidentifier] NOT NULL,
        [State] [int],
        [StartDate] [datetime] NOT NULL,
        [EndDate] [datetime] NOT NULL,
        [ParticipationPercentage] [int] NOT NULL,
        [LastModifiedBy] [nvarchar](100),
        [ExpectedVisitorCount] [int],
        [ActualVisitorCount] [int] NOT NULL,
        [ConfidenceLevel] [float] NOT NULL,
        [ZScore] [float] NOT NULL,
        [IsSignificant] [bit] NOT NULL,
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABTest] PRIMARY KEY ([Id])
    )
    CREATE TABLE [dbo].[tblABKeyPerformanceIndicator] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [KeyPerformanceIndicatorId] [uniqueidentifier],
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABKeyPerformanceIndicator] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblABKeyPerformanceIndicator]([TestId])
    CREATE TABLE [dbo].[tblABTestResult] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [ItemId] [uniqueidentifier] NOT NULL,
        [ItemVersion] [int] NOT NULL,
        [Views] [int] NOT NULL,
        [Conversions] [int] NOT NULL,
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABTestResult] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblABTestResult]([TestId])
    CREATE TABLE [dbo].[tblABVariant] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [ItemId] [uniqueidentifier] NOT NULL,
        [ItemVersion] [int] NOT NULL,
        [IsWinner] [bit] NOT NULL,
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABVariant] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblABVariant]([TestId])
    ALTER TABLE [dbo].[tblABKeyPerformanceIndicator] ADD CONSTRAINT [FK_dbo.tblABKeyPerformanceIndicator_dbo.tblABTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblABTest] ([Id]) ON DELETE CASCADE
    ALTER TABLE [dbo].[tblABTestResult] ADD CONSTRAINT [FK_dbo.tblABTestResult_dbo.tblABTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblABTest] ([Id]) ON DELETE CASCADE
    ALTER TABLE [dbo].[tblABVariant] ADD CONSTRAINT [FK_dbo.tblABVariant_dbo.tblABTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblABTest] ([Id]) ON DELETE CASCADE
	IF object_id('[dbo].[__MigrationHistory]') IS NULL
	BEGIN
		CREATE TABLE [dbo].[__MigrationHistory] (
			[MigrationId] [nvarchar](150) NOT NULL,
			[ContextKey] [nvarchar](300) NOT NULL,
			[Model] [varbinary](max) NOT NULL,
			[ProductVersion] [nvarchar](32) NOT NULL,
			CONSTRAINT [PK_dbo.__MigrationHistory] PRIMARY KEY ([MigrationId], [ContextKey])
		)
	END
    INSERT [dbo].[__MigrationHistory]([MigrationId], [ContextKey], [Model], [ProductVersion])
    VALUES (N'201603241337050_Initial', N'Testing.Migrations.Configuration',  0x1F8B0800000000000400ED5CDD6EE33616BE5F60DF41D0E522B59D0C0AB481DD22939FC2D8C9248833D9C5DE0C68E9D8212A51AE48A53116FB64BDE823ED2BEC91AD3F92A24C494EEA7483B998843F1F790ECFE139A43EE6BFBFFD3EFEF1390C9C2788398DD8C43D1E8C5C079817F9942D276E2216DF7CE7FEF8C35FFF32BEF4C367E7216FF7216D873D199FB88F42AC4E8743EE3D4248F820A45E1CF16821065E140E891F0D4F46A3EF87C7C743400817B11C677C97304143D8FC82BF9E47CC83954848701DF910F0AC1C6B661B54E7330981AF880713F7F296CE20C6190FAE49FC33089CE8E01EF8E6FF0B12B8CE5940094E6B06C1C2750863912002277DFA85C34CC4115BCE56584082FBF50AB0DD82041C32614ECBE6B6728D4E52B98665C71CCA4BB888C29680C71F32450DD5EE9DD4ED168A44555EA2CAC53A957AA3CE897BF631D59BEBA8439D9E0771DA6CA7AE075BC8C116E8C8C9AA8E0A3B41734AFF1D39E749209218260C121193E0C8B94DE601F5FE0EEBFBE867601396044175B2385DAC930AB0E8368E56108BF51D2C3211A6BEEB0CE57E43B563D1ADD2672BDE4F09C59F3FE3D8641E40610AC3C6EEF754049023A041A1C0AE734D9E3F015B8AC7897BF2EDB7AE73459FC1CF4B32D82F8CA25F61271127D07AD80BE05E4C575B53E83D78F35837BF32881B46391E8D5E42C49B982E2923C15440D873916668C9E522E14EB031DBAC7467D7585C54BAA73FDFE366D57A1297CCDF0BCE2D4E887A74B571CE5B883D60822C0BDC29131F4E5A837E225CE0664B1714FC8FEB3D2CF60E5D3CAFC013E03F504E45149F47180014019A01CEBC343C34746F293F869C05F531D4C1277882A058A40837A6F64BF4AF9917C5D01364CA6774C970453C524AF7318A0220ACBD7C31A0BDEDC700733BE906F6993CD1E5D6766558DCA8D19A17518CB1C78329F351705C5CEE3A77106C3AF047BACAFCD7D0F86B1EC4AEE228BC8B02336CD6F2EB3D899790AA37B26A3E8B1274387BA1D24E77C031DED5CB51D6D74C5DABD466ABB7683BC1071253B4AFFAD965953553936BB47929D575931A0FCB0CA4312F31ACC81E121503F2FF4BE68242F684302850457DF35B536EFF2FB911E53E62B911E51ED7C9A5CA6D630F5E5482BD3B8E756CEF9FD3A6109996FBA53E0F147EE5BDB3A7ECCEA02FD09BDE0B5A0673D5E3CDE1BE93936731780F1E9E21BDBBF75B74EF29FF07659503FC9FF804D1E09AD699ACEA948644D7CE23935009BAD995C3945F056459DE36F6F6D074285E5E6AF4F6543CCDFB10076B84A8DA9EBC0ED710CE21CECD8C114FD02714E6810409168CB47593DA9FC9AD8F9B5B5F44AC6CAB5F0EC8C8B1F788D07ED1FE83BE5CDB85A9169E711E7974A3FDE6E4363721790697CC77DAA579E55D94F180738D4B4557B838B8C413F76F9AD8D68316C7B372D0DC11E4318E5D754BBE6117108000275DB0F4DAFA9C708FF8BA57A2567DB90477718881A597EB982070B436CA84BEE553965E6605AD2451502C43473ACB623CB5E602568046CF44AB75B499481E50F4C914632AAADCA5B9F1B062AECD56ACE724261B6A4850E47BD3FCE4606F9E0D1719876F91C6C9BF82111AD7E4E0ED4E09B826CB3045DFD22C8A34D6DEDC4C9753876F6BF5337F0543AB5F8703B3B26DB2837D04F628730322C89C7048CBE1B9EEBCF3052BB70915CF3E4FA89693E2CE404879241E65CBBC4EB11BCDF46400F355B686680CFE3B86C8E658DC2D6BC0D59D7A07567907ACA114DEA740545668A7D845D25DE964777BA69A54EB2CAB90B4694D34CB6D9D575586296C47DD20648D5968B3E6364157E08EF06E19E0F5F91776D5A01C73547F117DA847385D194D31C726EA54A65DBA4483020C71A697F4F961B2D8E58ABAF170CB7EC90AC643034D667C4D562B3CB8556833598933DB7266CEBF99B5E78F845B8CA1C76B6824C56C8B91D04BC81294DAF4A6D0872B1A7391EFDAAE73EE875A33754F37EC5FF968F2B6AD2F58BEA9E5EDD39FB30FD13BCED7F5A654AAF40AA50CD3309A0A0CDACAEB1D9D94C4440212D75C5A9D47411232733C37F7CE58285580ACC81E43A2945491A40A7BBC8C365245CA8A5A60281C10094CA9B347CD6E61AA60B55C901D18392F44C1C98BEDB10A664815A928B4C7313243AAB8C646F6E3A864912ABC5AD7420BB59C104925B52DEC47A8238D54F1EBEAEDD1350A49155AABB4C7CDC92455B8BCCC1E456193485B8D5CD542E2EA95B0246DB5C21E4FBE16AE02CA353AE278A8ECC7DA61440B02DAF94D8E295611C79853EE3304994E08ED639235D20B05A9ECA4284529C3E9D18CD2C039A80237347B37706B03574E03FB34EBCAF9B4BD2537753E64E3ADCB63DAE72FD2B74115AAA8B0C7CB180055A4ACA855F42B29004AE42B2BDE5DCFDAF58A13E83E9D2EBFCE69EF71C69EEFEED6D6DDCA2FF272169697BE3B8952ADDD89A84D8AD18BBB11E50E649CDD47EC7E4FA45D506C9BB80EAAEA0933F818CF786B8E0B3F481B0C66BF04E70185346FCE1B5C13CCA5D154B79FD3DD93D1E83BE515D2E1BC081A72EE0735F739FAB32079B55E81BB9330FA4B02E99949A49617F77B99C39E48EC3D92587F1ED3FFE18D0D76EB7736B5A09BC7177B7946D35BBBD2931A9ADA7F3B61B577353EFE2CF6F0AEA633CE8E77358A8C3D5ED5D82C6DDF47341D56C4FCA4A68BE88607358B2022EDC1E4F734DD306A9FD3CC6907C974225C679BAB23C25982F57E3FF10677748999A9C3691F7E5158789EB8FFDEF43F75A6FFFCBA8538726E628CD4A7CEC8F9CFFE1F3D34C969E3886FCDC04C87F1779BEA4818EE2D540D79B8CB1E2EBD0CE81804D477019D60DE9843D49E95DFBDE18D7B834AA4FF13E60E7B2341E71C8DD7A5DCEDE4EDEC8776DD89D9672412BC1671F9D0C87C7DA8CA7FB47955B9751DC9D1076E448D5F670ECC6E2CA9C67FB4D11454CA2EE4E6033717F3778503240CEB1C34C30719E55999910DBCBD22C6E83B8F7075B383DE3CE847166EC315364EA02BBBB8BA9335328B1B456F473F6E621F1B8739547EB26C3355466007BAB10D8FF91009C7DD94A0DB9EFAC9FFA0B8C4DD84546C5EFAC4FA226461FD0318EEAB953FBB875B3AA7CB1222FD237C0C3C69472DDA4CD922CA377665467913F5B00282E0E1849CC57888239EC06A0F38DFFC75A9EC99E66538077FCA6E12B14A048A0CE13C9008846980681A7FC38896E73CBED97CA9E1FB1001A749D3F3D50DFB98D0A07C5E7A5573BE3240A491E727C0F2ED5A622013B05C17489F37AF5C6D8032F51501F31EC2558060FC86CD48E5596D8BB97DE1F00996C45BE7DF31CD20BB174256FBF88292654C429E6194FDF157B4613F7CFEE17F9CA4A9977D520000 , N'6.1.3-40302')
END


GO
