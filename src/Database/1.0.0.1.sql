--beginvalidatingquery
	if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[sp_DatabaseVersion]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)
    begin
		 select 1, 'Upgrading database'
    end
    else
		select -1, 'Not an EPiServer database'
--endvalidatingquery

-- Create MultivariateTest Tables to Store MultivariateTest Information.
DECLARE @CurrentMigration [nvarchar](max)

IF object_id('[dbo].[__MigrationHistory]') IS NOT NULL
    SELECT @CurrentMigration =
        (SELECT TOP (1) 
        [Project1].[MigrationId] AS [MigrationId]
        FROM ( SELECT 
        [Extent1].[MigrationId] AS [MigrationId]
        FROM [dbo].[__MigrationHistory] AS [Extent1]
        WHERE [Extent1].[ContextKey] = N'Testing.Migrations.Configuration'
        )  AS [Project1]
        ORDER BY [Project1].[MigrationId] DESC)

IF @CurrentMigration IS NULL
    SET @CurrentMigration = '0'

IF @CurrentMigration < '201604221951354_Initial'
BEGIN
    CREATE TABLE [dbo].[tblABTest] (
        [Id] [uniqueidentifier] NOT NULL,
        [Title] [nvarchar](255) NOT NULL,
        [Description] [nvarchar](255),
        [Owner] [nvarchar](100) NOT NULL,
        [OriginalItemId] [uniqueidentifier] NOT NULL,
        [State] [int],
        [StartDate] [datetime] NOT NULL,
        [EndDate] [datetime] NOT NULL,
        [ParticipationPercentage] [int] NOT NULL,
        [LastModifiedBy] [nvarchar](100),
        [ExpectedVisitorCount] [int],
        [ActualVisitorCount] [int] NOT NULL,
        [ConfidenceLevel] [float] NOT NULL,
        [ZScore] [float] NOT NULL,
        [IsSignificant] [bit] NOT NULL,
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABTest] PRIMARY KEY ([Id])
    )
    CREATE TABLE [dbo].[tblABKeyPerformanceIndicator] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [KeyPerformanceIndicatorId] [uniqueidentifier],
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABKeyPerformanceIndicator] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblABKeyPerformanceIndicator]([TestId])
    CREATE TABLE [dbo].[tblABVariant] (
        [Id] [uniqueidentifier] NOT NULL,
        [TestId] [uniqueidentifier] NOT NULL,
        [ItemId] [uniqueidentifier] NOT NULL,
        [ItemVersion] [int] NOT NULL,
        [IsWinner] [bit] NOT NULL,
        [Conversions] [int] NOT NULL,
        [Views] [int] NOT NULL,
        [CreatedDate] [datetime] NOT NULL,
        [ModifiedDate] [datetime] NOT NULL,
        CONSTRAINT [PK_dbo.tblABVariant] PRIMARY KEY ([Id])
    )
    CREATE INDEX [IX_TestId] ON [dbo].[tblABVariant]([TestId])
    ALTER TABLE [dbo].[tblABKeyPerformanceIndicator] ADD CONSTRAINT [FK_dbo.tblABKeyPerformanceIndicator_dbo.tblABTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblABTest] ([Id]) ON DELETE CASCADE
    ALTER TABLE [dbo].[tblABVariant] ADD CONSTRAINT [FK_dbo.tblABVariant_dbo.tblABTest_TestId] FOREIGN KEY ([TestId]) REFERENCES [dbo].[tblABTest] ([Id]) ON DELETE CASCADE
	IF object_id('[dbo].[__MigrationHistory]') IS NULL
	BEGIN
		CREATE TABLE [dbo].[__MigrationHistory] (
			[MigrationId] [nvarchar](150) NOT NULL,
			[ContextKey] [nvarchar](300) NOT NULL,
			[Model] [varbinary](max) NOT NULL,
			[ProductVersion] [nvarchar](32) NOT NULL,
			CONSTRAINT [PK_dbo.__MigrationHistory] PRIMARY KEY ([MigrationId], [ContextKey])
		)
	END
    INSERT [dbo].[__MigrationHistory]([MigrationId], [ContextKey], [Model], [ProductVersion])
    VALUES (N'201604221951354_Initial', N'Testing.Migrations.Configuration',  0x1F8B0800000000000400ED5C5B6F1B37167E5F60FFC3601E17AEC64E50A035A4168E6C07C2C6B11139DEA22F0135732413E1705492E35828F697ED437F52FFC29E91E642722E9A8B62D86D9087D8BC7CE4B9F05CE69CE4CFFFFD31FEF93164CE030849233E714F46C7AE03DC8F02CA57133756CBEF7E707FFEE99FFF185F04E1A37397AD7B9DACC39D5C4EDC7BA5D6A79E27FD7B08891C85D417918C966AE447A14782C87B757CFCA37772E20142B888E538E30F31573484ED2FF8EB34E23EAC554CD855140093E938CECCB7A8CE7B12825C131F26EEC50D9D83C01B8FAE88F80C0A2F3ABA05B9FDFB9C30D7396394E0B5E6C096AE43388F145178E9D38F12E64A447C355FE30061B79B35E0BA25611252624E8BE56DE93A7E95D0E5151B33283F962A0A3B029EBC4E19E5D9DB7BB1DBCD1989ACBC4096AB4D42F5969D1317B975F626619DEBD8A79D4E994856EE65F76887BA15DB28073C72D22547B9CAA066257F8E9C69CC542C60C2215682B023E7265E30EAFF1B36B7D167E0131E33A6DF1B6F8E73C6000EDD88680D426D3EC032A56616B88E67EEF3EC8DF9366DCF8ECCB731C59FDFE3D964C120D70AAF71FB2D550C3204D42D24D875AEC8E33BE02B753F715F7DFFBDEB5CD24708B29114F623A7F8C470931231743EF61CA42FE87AA715830F6F3EEBFA0B07D170CAC9F1F1D720F15AD015E584CD1484038534478D2E8484462151D3443DD389BDBB853AD710929F6FD17475BEC7050F0E82738317A23E5D6FDFE90D081FB822AB1C77C6D5EB579D41DF11A9F00DD32585E0CDE600F2DEC38BC735F80A823B2AA98AC43442776011D00C70E627CEA2617B47FAD1012D69808E0FDEC103B05C4811DAA6EE22FA75EE47020682CCE49CAE384AC42705756FA28801E1DDE91380FA761805CCF4A41FD87BF240573BDD3561D156A3362F23816EC887190F907014AE749D0FC0B61BE43D5D174FB866FD27CDAB5D8A28FC10B19DABDBBBFED32D112B48581D75D8348F627C82EDC9BC2382A2406BC94AE76BC928CD575DBBBCA8EA9A63AF0809F6050A358C3860E45073C2DF259440220742D430D0467DF186427B194F6519B2D7D3C93264EFB2EF934B1FF1019F588AF8ED49B5F6C1C3C3CF0422E5F2B0106526FF43B9168CF70E05229EA6FB72D885EE287C1908F157B036DD1D768535A9F7EAEDAC471C9AB643CB6F66F2929155F1A1E330D62439521A99D460AB82294400826D1042D729534E57102E40644F82135FD10724EA8EB018078E4B7235D69F99AB4F9A579F47BC585BCE484C64E1DF237490AF7F5D96DC4E46FAE09994914FB752D81B6969FA65DE03F34AA78F2B33F2E1DAF0EE0A2547D7282B94FCC4FD57890B1D4FCF6355E3F4ECDD98879DB8B65BB9E6E7C04081930832F9A23625D22741F93523B70373043D1108CC9429616800256A21E5AAECB6284F326BD683240BABA5134CEE9A9F6ACF9CC31AF04970D543BE6DAE9339C8F295F2932DB6EEE3E2D8D3547AAFA6972D67836E3598514397F2A8A993E63664552F45536B49781ACDAC95CF33D3C49D13C33D0A7714B69E28B22012927178AC8AB93FE2E4CE51CAF41B97AD4E09EE1C54E611B64CC0F8A870D965352AA9A48951FF49A40AB4D686EF39A5F82251859ABF270B45636F01D52EF9D2B67649DA6CDDE8E9F872F29BF85B52C49E7E4E3B2C5708DB02989C6CC7E58AA0B392AB7B4C6C7B23AB1152E84B3397EA6DEA20AE644170FE848B62A1B7AB16665545AFA6AC38BE22EB3546995A99311D71E6BB1AE3F4BB79F77A5BB8C3F07C595176CB6F9B9F840A435660CD26E95900975448959924D799066169996DB06A9E78769A6993CA62CBDE7DB63EF939FD54BF2729A8D5AC82AB97486898388B8466D084DFB0775BFA258C888A6F02D388C521AF775CF5BBD3829D0E900EB5C730AA6F3A9231D11E2FADB0E948E950070CAB5C66805973ED51D3045207ABAC99EDC1C8EA67164E36DC1E2BAFA0E948F9607B9CDA0A9A8E5BBBA8FD3976514D87B7E73A70A1B27666B0A47245FB13AA8A6B3A7ED57C7BF452A94D872E4DB6C7CD8A6E3A5C36D61EC5AABA19A6C69CEA40B1FE95CBA0569F688F677EE9D201CD9932E2D8B34C7229DE2EB98252BA627A96567EA736CE3AB023AA8B807B79A6D6605FC955A52991E1AB6AD2A47A94869A900EDCB0EC9B9AB756F33C303EB05A6729582F35AEDDFC9CD5B62A8EE91EBF18A5171B2A9FE8E21BB20A8CE916B2D14E3EB0A8C158FEAF98688F97966274A474E8DBF3B5A64BE9A3BD243F3D4F23AD74719CA66EFB5B554BB9DC6E89EB20AB1E30CCC13C6EBE91A88CA364C168FE1B9B320A4970912DB8221870E0F3D995495C4C357FB01A5C9F4FB3A92765C0DA769C3E790939E6F4B71892D85225CA2786357BF20722FC7B22CA1D97C37B39DB60776EDDAC04DD36F31DA4337330778D2E4D9A3C816EC496FA3403FC591DA04FB337CE9E3E4D8BC6015D9A6D443BB429B38744EA5B34FB905ED3A0B96411E90E66F667F6C3A86CCF5CD01E94957B207AEB5C550F444BB0433403BE40A36EF40895E14A652024161E27EEEFDBFDA7CEEC974F3B8823E75AA0BF3E758E9DFF1EBE73AF89CE366FF105EA5865DEF24DA77AB6AE0D26AAA28DAD8F19B79BD87A19CC72035B9FAB18ED6BBD5CD2F37E54876F2ECA2A8D4FDE12D1A6F87AB08EA6BEFD17B555B027EC037A6ECD16C3DB7E9E87CEE54D103D7B8D5E844ED57F667C860D3BE53279CD27DA721B6F5343CEEE030DDADE4584C24E03AC45DB7E9D26B3D3A963A7F61A7D7B7C74656DECF2A93DF985F4019942B6BA0CFAB5F5D8606D65F09C1A7B86B0C5521CBBB0F0553A77CA9F58D18268FF6700DA2F89E9770E91FC0F021C7CC376E46B667C196526CCBA51B6C40EC740110CBFC899C07099F80AA77D9072FB8F61D306EF8B7001C18C5FC76A1D2B2419C20533EAF889296C3A7FDB9E64DE797CBDFD10280F41025E932611E4357F13535634A65F5644903510898D7D0B38BE93259A6C05AB4D8EF47EDB1FDF0628655FEE1A6E215C330493D77C4EB486FC0E77FB28E11DAC88BFC9BE94D783EC1784C9F6F139252B4142996214FBF157D4E1207CFCE9FF33164BFE3A430000 , N'6.1.3-40302')
END


GO
